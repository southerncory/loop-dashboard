---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Login | Loop Command Center">
  <div class="min-h-screen flex items-center justify-center p-6">
    <div class="bg-slate-800 rounded-xl border border-slate-700 p-8 w-full max-w-md">
      <div class="text-center mb-8">
        <h1 class="text-2xl font-bold mb-2">ğŸ” Command Center</h1>
        <p class="text-slate-400">Enter your email to receive a login link</p>
      </div>

      <div id="login-form">
        <input 
          type="email" 
          id="email" 
          placeholder="you@example.com"
          class="w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:border-emerald-500 mb-4"
        />
        <button 
          id="login-btn"
          class="w-full px-4 py-3 bg-emerald-600 hover:bg-emerald-500 rounded-lg font-medium transition-colors"
        >
          Send Magic Link âœ¨
        </button>
        <p id="error-msg" class="text-red-400 text-sm mt-3 hidden"></p>
      </div>

      <div id="success-msg" class="hidden text-center">
        <div class="text-4xl mb-4">ğŸ“§</div>
        <h2 class="text-xl font-semibold mb-2">Check your email!</h2>
        <p class="text-slate-400">Click the link we sent to log in.</p>
      </div>

      <div id="loading" class="hidden text-center">
        <div class="text-4xl mb-4 animate-pulse">â³</div>
        <p class="text-slate-400">Sending...</p>
      </div>
    </div>
  </div>

  <script>
    import { supabase, isAllowedEmail } from '../lib/supabase'

    const emailInput = document.getElementById('email') as HTMLInputElement
    const loginBtn = document.getElementById('login-btn') as HTMLButtonElement
    const loginForm = document.getElementById('login-form') as HTMLDivElement
    const successMsg = document.getElementById('success-msg') as HTMLDivElement
    const loadingDiv = document.getElementById('loading') as HTMLDivElement
    const errorMsg = document.getElementById('error-msg') as HTMLParagraphElement

    // Check if already logged in
    async function checkAuth() {
      const { data: { session } } = await supabase.auth.getSession()
      if (session?.user?.email && isAllowedEmail(session.user.email)) {
        // Redirect to intended page or support
        const redirect = new URLSearchParams(window.location.search).get('redirect') || '/support'
        window.location.href = redirect
      }
    }
    checkAuth()

    // Handle login
    loginBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim().toLowerCase()
      
      if (!email) {
        errorMsg.textContent = 'Please enter your email'
        errorMsg.classList.remove('hidden')
        return
      }

      if (!isAllowedEmail(email)) {
        errorMsg.textContent = 'Access restricted. Contact admin.'
        errorMsg.classList.remove('hidden')
        return
      }

      errorMsg.classList.add('hidden')
      loginForm.classList.add('hidden')
      loadingDiv.classList.remove('hidden')

      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: {
          emailRedirectTo: window.location.origin + '/auth/callback'
        }
      })

      loadingDiv.classList.add('hidden')

      if (error) {
        loginForm.classList.remove('hidden')
        errorMsg.textContent = error.message
        errorMsg.classList.remove('hidden')
      } else {
        successMsg.classList.remove('hidden')
      }
    })

    // Enter key to submit
    emailInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') loginBtn.click()
    })
  </script>
</Layout>
