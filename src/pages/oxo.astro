---
import DashboardLayout from '../layouts/DashboardLayout.astro';
---

<DashboardLayout title="OXO Token | Loop" active="oxo">
  <div class="min-h-screen bg-[#0f1419] p-4 md:p-6">
    <!-- Header -->
    <header class="mb-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-xl font-semibold text-slate-100">OXO Token</h1>
          <p class="text-slate-500 text-sm mt-0.5">Token controls and status</p>
        </div>
        <button id="btn-refresh" class="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 border border-slate-700/50 rounded text-sm text-slate-300 transition-colors">
          Refresh
        </button>
      </div>
    </header>

    <!-- Loading -->
    <div id="loading-state" class="text-center py-20">
      <div class="w-6 h-6 border-2 border-emerald-500/30 border-t-emerald-500 rounded-full animate-spin mx-auto mb-3"></div>
      <p class="text-slate-500 text-sm">Loading OXO status...</p>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="hidden space-y-4">
      <!-- Status Banner -->
      <div id="status-banner" class="p-3 rounded-lg border"></div>

      <!-- Stats -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg p-3">
          <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">Price</div>
          <div id="stat-price" class="text-xl font-semibold font-mono text-amber-400">$0</div>
          <div class="text-xs text-slate-600 mt-0.5">per OXO</div>
        </div>
        <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg p-3">
          <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">Circulating</div>
          <div id="stat-circulating" class="text-xl font-semibold font-mono text-blue-400">0</div>
          <div id="stat-circulating-pct" class="text-xs text-slate-600 mt-0.5">0% of supply</div>
        </div>
        <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg p-3">
          <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">Market Cap</div>
          <div id="stat-marketcap" class="text-xl font-semibold font-mono text-green-400">$0</div>
          <div class="text-xs text-slate-600 mt-0.5">fully diluted</div>
        </div>
        <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg p-3">
          <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">Treasury</div>
          <div id="stat-treasury" class="text-xl font-semibold font-mono text-purple-400">0</div>
          <div class="text-xs text-slate-600 mt-0.5">OXO reserved</div>
        </div>
      </div>

      <!-- Bonding Curve -->
      <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg">
        <div class="p-3 border-b border-slate-700/50">
          <h2 class="text-sm font-medium text-slate-200">Bonding Curve</h2>
        </div>
        <div class="p-4">
          <div class="h-32 flex items-end justify-between gap-1" id="curve-chart"></div>
          <div class="flex justify-between text-xs text-slate-600 mt-2 font-mono">
            <span>0%</span>
            <span>25%</span>
            <span>50%</span>
            <span>75%</span>
            <span>100%</span>
          </div>
          <div class="text-center text-xs text-slate-500 mt-2">Circulation %</div>
        </div>
      </div>

      <!-- Emergency Controls -->
      <div class="bg-[#1a2028] border border-red-500/20 rounded-lg">
        <div class="p-3 border-b border-slate-700/50 flex items-center justify-between">
          <h2 class="text-sm font-medium text-red-400">Emergency Controls</h2>
          <span class="text-xs text-slate-500">Admin only</span>
        </div>
        <div class="p-4 space-y-3">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm text-slate-200">Pause Trading</div>
              <div class="text-xs text-slate-500">Halt all OXO transfers</div>
            </div>
            <button id="btn-pause" class="px-3 py-1.5 bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 rounded text-sm text-red-400 transition-colors">
              Pause
            </button>
          </div>
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm text-slate-200">Freeze Account</div>
              <div class="text-xs text-slate-500">Block specific address</div>
            </div>
            <button id="btn-freeze" class="px-3 py-1.5 bg-orange-500/10 hover:bg-orange-500/20 border border-orange-500/30 rounded text-sm text-orange-400 transition-colors">
              Freeze
            </button>
          </div>
        </div>
      </div>

      <!-- Token Info -->
      <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg">
        <div class="p-3 border-b border-slate-700/50">
          <h2 class="text-sm font-medium text-slate-200">Token Details</h2>
        </div>
        <div class="p-4 space-y-2">
          <div class="flex justify-between text-sm">
            <span class="text-slate-500">Total Supply</span>
            <span class="text-slate-300 font-mono">1,000,000,000 OXO</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-slate-500">Network</span>
            <span class="text-slate-300">Solana</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-slate-500">Mint Authority</span>
            <span class="text-slate-300">Disabled</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-slate-500">Freeze Authority</span>
            <span class="text-slate-300">Multi-sig</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const TOTAL_SUPPLY = 1_000_000_000;
    
    function formatNumber(n) {
      if (n >= 1_000_000_000) return (n / 1_000_000_000).toFixed(2) + 'B';
      if (n >= 1_000_000) return (n / 1_000_000).toFixed(2) + 'M';
      if (n >= 1_000) return (n / 1_000).toFixed(2) + 'K';
      return n.toFixed(2);
    }

    function bondingPrice(circulation) {
      const pct = circulation / TOTAL_SUPPLY;
      return 0.001 * Math.exp(3 * pct);
    }

    async function loadStatus() {
      // Simulated data - replace with real API
      const circulating = 50_000_000;
      const price = bondingPrice(circulating);
      const marketCap = circulating * price;
      const treasury = 200_000_000;
      
      document.getElementById('stat-price').textContent = '$' + price.toFixed(4);
      document.getElementById('stat-circulating').textContent = formatNumber(circulating);
      document.getElementById('stat-circulating-pct').textContent = ((circulating / TOTAL_SUPPLY) * 100).toFixed(1) + '% of supply';
      document.getElementById('stat-marketcap').textContent = '$' + formatNumber(marketCap);
      document.getElementById('stat-treasury').textContent = formatNumber(treasury);
      
      // Status banner
      const banner = document.getElementById('status-banner');
      banner.className = 'p-3 rounded-lg border bg-green-500/10 border-green-500/20';
      banner.innerHTML = `
        <div class="flex items-center gap-2">
          <span class="w-2 h-2 rounded-full bg-green-500"></span>
          <span class="text-sm font-medium text-green-400">Trading Active</span>
        </div>
      `;
      
      // Bonding curve chart
      const chart = document.getElementById('curve-chart');
      const points = 20;
      const currentPct = circulating / TOTAL_SUPPLY;
      
      let html = '';
      for (let i = 0; i <= points; i++) {
        const pct = i / points;
        const p = bondingPrice(pct * TOTAL_SUPPLY);
        const maxPrice = bondingPrice(TOTAL_SUPPLY);
        const height = (p / maxPrice) * 100;
        const isCurrent = Math.abs(pct - currentPct) < 0.05;
        const color = isCurrent ? 'bg-amber-500' : 'bg-slate-700';
        
        html += `<div class="flex-1 ${color} rounded-sm transition-all" style="height: ${Math.max(4, height)}%"></div>`;
      }
      chart.innerHTML = html;
      
      document.getElementById('loading-state').classList.add('hidden');
      document.getElementById('main-content').classList.remove('hidden');
    }

    document.getElementById('btn-refresh').addEventListener('click', loadStatus);
    
    document.getElementById('btn-pause').addEventListener('click', () => {
      alert('Pause functionality requires admin authentication');
    });
    
    document.getElementById('btn-freeze').addEventListener('click', () => {
      alert('Freeze functionality requires admin authentication');
    });
    
    loadStatus();
  </script>
</DashboardLayout>
