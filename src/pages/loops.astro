---
import DashboardLayout from '../layouts/DashboardLayout.astro';
---

<DashboardLayout title="Loops | Loop" active="loops">
  <div class="min-h-screen bg-[#0f1419] p-4 md:p-6">
    <!-- Header -->
    <header class="mb-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-xl font-semibold text-slate-100">Loops</h1>
          <p class="text-slate-500 text-sm mt-0.5">Geographic micro-economies</p>
        </div>
        <div class="flex gap-2">
          <button id="btn-create-loop" class="px-3 py-1.5 bg-emerald-600 hover:bg-emerald-500 rounded text-sm font-medium transition-colors">
            + Create
          </button>
          <button id="btn-refresh" class="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 border border-slate-700/50 rounded text-sm text-slate-300 transition-colors">
            Refresh
          </button>
        </div>
      </div>
    </header>

    <!-- Loading -->
    <div id="loading-state" class="text-center py-20">
      <div class="w-6 h-6 border-2 border-emerald-500/30 border-t-emerald-500 rounded-full animate-spin mx-auto mb-3"></div>
      <p class="text-slate-500 text-sm">Loading loops...</p>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="hidden space-y-4">
      <!-- Stats -->
      <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
        <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg p-3">
          <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">Total</div>
          <div id="stat-loops" class="text-xl font-semibold font-mono text-slate-100">0</div>
        </div>
        <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg p-3">
          <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">Active</div>
          <div id="stat-active" class="text-xl font-semibold font-mono text-green-400">0</div>
        </div>
        <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg p-3">
          <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">Users</div>
          <div id="stat-users" class="text-xl font-semibold font-mono text-blue-400">0</div>
        </div>
        <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg p-3">
          <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">Merchants</div>
          <div id="stat-merchants" class="text-xl font-semibold font-mono text-purple-400">0</div>
        </div>
        <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg p-3">
          <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">Volume</div>
          <div id="stat-volume" class="text-xl font-semibold font-mono text-amber-400">$0</div>
        </div>
      </div>

      <!-- Loops Grid -->
      <div id="loops-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </div>

    <!-- Create Modal -->
    <div id="create-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
      <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg p-4 w-full max-w-md mx-4">
        <h3 class="text-lg font-semibold text-slate-100 mb-4">Create Loop</h3>
        <form id="create-form" class="space-y-3">
          <div>
            <label class="block text-xs text-slate-500 uppercase tracking-wide mb-1">Name</label>
            <input type="text" name="name" required class="w-full bg-slate-800 border border-slate-700/50 rounded px-3 py-2 text-sm text-slate-200 focus:border-emerald-500 focus:outline-none">
          </div>
          <div>
            <label class="block text-xs text-slate-500 uppercase tracking-wide mb-1">City</label>
            <input type="text" name="city" required class="w-full bg-slate-800 border border-slate-700/50 rounded px-3 py-2 text-sm text-slate-200 focus:border-emerald-500 focus:outline-none">
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs text-slate-500 uppercase tracking-wide mb-1">Lat</label>
              <input type="number" name="lat" step="any" class="w-full bg-slate-800 border border-slate-700/50 rounded px-3 py-2 text-sm text-slate-200 focus:border-emerald-500 focus:outline-none">
            </div>
            <div>
              <label class="block text-xs text-slate-500 uppercase tracking-wide mb-1">Lng</label>
              <input type="number" name="lng" step="any" class="w-full bg-slate-800 border border-slate-700/50 rounded px-3 py-2 text-sm text-slate-200 focus:border-emerald-500 focus:outline-none">
            </div>
          </div>
          <div class="flex gap-2 pt-2">
            <button type="submit" class="flex-1 px-3 py-2 bg-emerald-600 hover:bg-emerald-500 rounded text-sm font-medium transition-colors">
              Create
            </button>
            <button type="button" id="btn-cancel" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded text-sm font-medium transition-colors">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://ibhjsutgxhujbjhrilwx.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImliaGpzdXRneGh1amJqaHJpbHd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzNzkzODgsImV4cCI6MjA4NDk1NTM4OH0.5BWyde9ozVjf9KV-se6o0g6zf2MBWlUWU6pN98KaOO4';

    async function fetchLoops() {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/loops?select=*,merchants:merchants(count),users:loop_memberships(count)`, {
        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
      });
      return res.json();
    }

    async function loadData() {
      try {
        const loops = await fetchLoops();
        
        const active = loops.filter(l => l.is_active).length;
        const totalUsers = loops.reduce((s, l) => s + (l.users?.[0]?.count || 0), 0);
        const totalMerchants = loops.reduce((s, l) => s + (l.merchants?.[0]?.count || 0), 0);
        
        document.getElementById('stat-loops').textContent = loops.length;
        document.getElementById('stat-active').textContent = active;
        document.getElementById('stat-users').textContent = totalUsers;
        document.getElementById('stat-merchants').textContent = totalMerchants;
        document.getElementById('stat-volume').textContent = '$0';
        
        const grid = document.getElementById('loops-grid');
        if (loops.length === 0) {
          grid.innerHTML = '<div class="col-span-full text-center py-8 text-slate-600 text-sm">No loops created yet</div>';
        } else {
          grid.innerHTML = loops.map(loop => `
            <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg p-4 hover:border-slate-600 transition-colors">
              <div class="flex items-start justify-between mb-3">
                <div>
                  <h3 class="font-medium text-slate-200">${loop.name}</h3>
                  <p class="text-xs text-slate-500">${loop.city || 'No city'}</p>
                </div>
                <span class="w-2 h-2 rounded-full ${loop.is_active ? 'bg-green-500' : 'bg-slate-600'}"></span>
              </div>
              <div class="grid grid-cols-2 gap-2 text-sm">
                <div>
                  <div class="text-slate-500 text-xs">Users</div>
                  <div class="text-slate-300 font-mono">${loop.users?.[0]?.count || 0}</div>
                </div>
                <div>
                  <div class="text-slate-500 text-xs">Merchants</div>
                  <div class="text-slate-300 font-mono">${loop.merchants?.[0]?.count || 0}</div>
                </div>
              </div>
            </div>
          `).join('');
        }
        
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');
      } catch (err) {
        console.error('Failed to load loops:', err);
      }
    }

    document.getElementById('btn-refresh').addEventListener('click', loadData);
    
    document.getElementById('btn-create-loop').addEventListener('click', () => {
      document.getElementById('create-modal').classList.remove('hidden');
      document.getElementById('create-modal').classList.add('flex');
    });
    
    document.getElementById('btn-cancel').addEventListener('click', () => {
      document.getElementById('create-modal').classList.add('hidden');
      document.getElementById('create-modal').classList.remove('flex');
    });

    document.getElementById('create-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const data = {
        name: form.name.value,
        city: form.city.value,
        latitude: parseFloat(form.lat.value) || null,
        longitude: parseFloat(form.lng.value) || null,
        is_active: true
      };
      
      try {
        await fetch(`${SUPABASE_URL}/rest/v1/loops`, {
          method: 'POST',
          headers: { 
            'apikey': SUPABASE_KEY, 
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify(data)
        });
        
        document.getElementById('create-modal').classList.add('hidden');
        document.getElementById('create-modal').classList.remove('flex');
        form.reset();
        loadData();
      } catch (err) {
        alert('Failed to create loop');
      }
    });

    loadData();
  </script>
</DashboardLayout>
