---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Logging in... | Loop">
  <div class="min-h-screen flex items-center justify-center p-6">
    <div class="text-center">
      <div class="text-4xl mb-4 animate-pulse">ðŸ”“</div>
      <h1 class="text-xl font-semibold mb-2">Logging you in...</h1>
      <p class="text-slate-400">Please wait</p>
    </div>
  </div>

  <script>
    import { supabase, isAllowedEmail } from '../../lib/supabase'

    async function handleCallback() {
      // Get the session from the URL hash
      const { data: { session }, error } = await supabase.auth.getSession()
      
      if (error) {
        console.error('Auth error:', error)
        window.location.href = '/login?error=' + encodeURIComponent(error.message)
        return
      }

      if (session?.user?.email) {
        if (isAllowedEmail(session.user.email)) {
          // Success - redirect to support
          window.location.href = '/support'
        } else {
          // Not allowed
          await supabase.auth.signOut()
          window.location.href = '/login?error=Access+restricted'
        }
      } else {
        // Try to exchange the code
        const hashParams = new URLSearchParams(window.location.hash.substring(1))
        const accessToken = hashParams.get('access_token')
        
        if (accessToken) {
          // Session should be set automatically, wait a moment and check again
          setTimeout(async () => {
            const { data: { session } } = await supabase.auth.getSession()
            if (session?.user?.email && isAllowedEmail(session.user.email)) {
              window.location.href = '/support'
            } else {
              window.location.href = '/login?error=Auth+failed'
            }
          }, 1000)
        } else {
          window.location.href = '/login'
        }
      }
    }

    handleCallback()
  </script>
</Layout>
