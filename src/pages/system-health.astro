---
import DashboardLayout from '../layouts/DashboardLayout.astro';
import auditData from '../data/audits.json';

const audits = auditData.audits;
const lastUpdated = new Date(auditData.lastUpdated).toLocaleDateString('en-US', { 
  year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' 
});

const totalFixed = audits.reduce((sum, a) => sum + a.fixedIssues.length, 0);
const openIssues = audits.flatMap(a => a.openIssues);
const criticalOpen = openIssues.filter(i => i.severity === 'critical').length;
const blockedOpen = openIssues.filter(i => i.severity === 'blocked').length;
const techDebtOpen = openIssues.filter(i => i.severity === 'tech-debt').length;
const lowOpen = openIssues.filter(i => i.severity === 'low' || i.severity === 'waiting').length;

const getStatusColor = (status: string) => {
  const colors = {
    pass: 'bg-green-500/10 text-green-400 border-green-500/20',
    partial: 'bg-amber-500/10 text-amber-400 border-amber-500/20',
    warning: 'bg-orange-500/10 text-orange-400 border-orange-500/20',
    fail: 'bg-red-500/10 text-red-400 border-red-500/20'
  };
  return colors[status] || 'bg-slate-500/10 text-slate-400 border-slate-500/20';
};

const getSeverityBadge = (severity: string) => {
  const colors = {
    critical: 'bg-red-500/10 text-red-400 border-red-500/20',
    blocked: 'bg-orange-500/10 text-orange-400 border-orange-500/20',
    'tech-debt': 'bg-amber-500/10 text-amber-400 border-amber-500/20',
    low: 'bg-slate-500/10 text-slate-400 border-slate-500/20',
    waiting: 'bg-blue-500/10 text-blue-400 border-blue-500/20'
  };
  return colors[severity] || 'bg-slate-500/10 text-slate-400 border-slate-500/20';
};
---

<DashboardLayout title="System Health | Loop" active="system-health">
  <div class="min-h-screen bg-[#0f1419] p-4 md:p-6 space-y-4">
    <!-- Header -->
    <header class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
      <div>
        <h1 class="text-xl font-semibold text-slate-100">System Health</h1>
        <p class="text-slate-500 text-sm mt-0.5">Audits and infrastructure status</p>
      </div>
      <span class="text-xs text-slate-600 font-mono">{lastUpdated}</span>
    </header>

    <!-- Stats -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
      <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg p-3">
        <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">Audits</div>
        <div class="text-xl font-semibold font-mono text-slate-100">{audits.length}</div>
        <div class="text-xs text-green-400 mt-0.5">{audits.filter(a => a.status === 'pass').length} passing</div>
      </div>
      <div class="bg-[#1a2028] border border-green-500/20 rounded-lg p-3">
        <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">Fixed</div>
        <div class="text-xl font-semibold font-mono text-green-400">{totalFixed}</div>
        <div class="text-xs text-slate-600 mt-0.5">resolved</div>
      </div>
      <div class="bg-[#1a2028] border border-orange-500/20 rounded-lg p-3">
        <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">Blocked</div>
        <div class="text-xl font-semibold font-mono text-orange-400">{blockedOpen}</div>
        <div class="text-xs text-slate-600 mt-0.5">external</div>
      </div>
      <div class="bg-[#1a2028] border border-amber-500/20 rounded-lg p-3">
        <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">Tech Debt</div>
        <div class="text-xl font-semibold font-mono text-amber-400">{techDebtOpen}</div>
        <div class="text-xs text-slate-600 mt-0.5">pending</div>
      </div>
      <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg p-3">
        <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">Low/Waiting</div>
        <div class="text-xl font-semibold font-mono text-slate-400">{lowOpen}</div>
        <div class="text-xs text-slate-600 mt-0.5">deferred</div>
      </div>
    </div>

    <!-- Audits List -->
    <div class="space-y-3">
      {audits.map((audit) => (
        <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg overflow-hidden">
          <button
            class="audit-toggle w-full p-3 flex items-center justify-between hover:bg-slate-800/30 transition-colors"
            data-target={`audit-${audit.id}`}
          >
            <div class="flex items-center gap-3">
              <span class={`w-2 h-2 rounded-full ${audit.status === 'pass' ? 'bg-green-500' : audit.status === 'partial' ? 'bg-amber-500' : 'bg-red-500'}`}></span>
              <div class="text-left">
                <div class="text-sm font-medium text-slate-200">{audit.name}</div>
                <div class="text-xs text-slate-500">{audit.category}</div>
              </div>
            </div>
            <div class="flex items-center gap-3">
              <span class={`text-xs px-2 py-0.5 rounded border ${getStatusColor(audit.status)}`}>
                {audit.status}
              </span>
              <span class="text-xs text-slate-600 font-mono">{audit.fixedIssues.length}F / {audit.openIssues.length}O</span>
              <svg class="w-4 h-4 text-slate-500 transition-transform audit-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </div>
          </button>
          
          <div id={`audit-${audit.id}`} class="hidden border-t border-slate-700/50">
            {audit.fixedIssues.length > 0 && (
              <div class="p-3 border-b border-slate-700/30">
                <div class="text-xs text-green-400 uppercase tracking-wide mb-2">Fixed ({audit.fixedIssues.length})</div>
                <div class="space-y-1">
                  {audit.fixedIssues.map((issue) => (
                    <div class="flex items-start gap-2 text-sm text-slate-400">
                      <span class="text-green-500 mt-0.5">â€¢</span>
                      <span>{issue}</span>
                    </div>
                  ))}
                </div>
              </div>
            )}
            
            {audit.openIssues.length > 0 && (
              <div class="p-3">
                <div class="text-xs text-slate-500 uppercase tracking-wide mb-2">Open ({audit.openIssues.length})</div>
                <div class="space-y-2">
                  {audit.openIssues.map((issue) => (
                    <div class="flex items-start gap-2 text-sm">
                      <span class={`text-xs px-1.5 py-0.5 rounded border ${getSeverityBadge(issue.severity)}`}>
                        {issue.severity}
                      </span>
                      <span class="text-slate-300">{issue.description}</span>
                    </div>
                  ))}
                </div>
              </div>
            )}
            
            {audit.fixedIssues.length === 0 && audit.openIssues.length === 0 && (
              <div class="p-4 text-center text-slate-600 text-sm">
                No issues tracked for this audit
              </div>
            )}
          </div>
        </div>
      ))}
    </div>

    <!-- Live Services -->
    <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg">
      <div class="p-3 border-b border-slate-700/50">
        <h2 class="text-sm font-medium text-slate-200">Live Services</h2>
      </div>
      <div class="p-3">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="flex items-center gap-2">
            <span id="svc-supabase" class="w-2 h-2 rounded-full bg-slate-600"></span>
            <span class="text-sm text-slate-300">Supabase</span>
          </div>
          <div class="flex items-center gap-2">
            <span id="svc-vercel" class="w-2 h-2 rounded-full bg-slate-600"></span>
            <span class="text-sm text-slate-300">Vercel</span>
          </div>
          <div class="flex items-center gap-2">
            <span id="svc-stripe" class="w-2 h-2 rounded-full bg-slate-600"></span>
            <span class="text-sm text-slate-300">Stripe</span>
          </div>
          <div class="flex items-center gap-2">
            <span id="svc-twilio" class="w-2 h-2 rounded-full bg-slate-600"></span>
            <span class="text-sm text-slate-300">Twilio</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Accordion toggles
    document.querySelectorAll('.audit-toggle').forEach(btn => {
      btn.addEventListener('click', () => {
        const targetId = btn.getAttribute('data-target');
        const target = document.getElementById(targetId);
        const chevron = btn.querySelector('.audit-chevron');
        
        target.classList.toggle('hidden');
        chevron.classList.toggle('rotate-180');
      });
    });

    // Live service checks
    async function checkServices() {
      // Supabase
      try {
        const res = await fetch('https://ibhjsutgxhujbjhrilwx.supabase.co/rest/v1/', {
          headers: { 'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImliaGpzdXRneGh1amJqaHJpbHd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzNzkzODgsImV4cCI6MjA4NDk1NTM4OH0.5BWyde9ozVjf9KV-se6o0g6zf2MBWlUWU6pN98KaOO4' }
        });
        document.getElementById('svc-supabase').className = res.ok ? 'w-2 h-2 rounded-full bg-green-500' : 'w-2 h-2 rounded-full bg-red-500';
      } catch {
        document.getElementById('svc-supabase').className = 'w-2 h-2 rounded-full bg-red-500';
      }

      // Vercel (check app)
      try {
        const res = await fetch('https://app.looplocal.io', { mode: 'no-cors' });
        document.getElementById('svc-vercel').className = 'w-2 h-2 rounded-full bg-green-500';
      } catch {
        document.getElementById('svc-vercel').className = 'w-2 h-2 rounded-full bg-amber-500';
      }

      // Others assumed OK if page loads
      document.getElementById('svc-stripe').className = 'w-2 h-2 rounded-full bg-green-500';
      document.getElementById('svc-twilio').className = 'w-2 h-2 rounded-full bg-green-500';
    }

    checkServices();
  </script>
</DashboardLayout>
