---
import DashboardLayout from '../layouts/DashboardLayout.astro';

// Audit data - Updated 2026-02-09
const audits = [
  {
    id: 'defi-infrastructure',
    name: 'DeFi Infrastructure',
    date: '2026-02-09',
    status: 'pass',
    grade: '‚úÖ',
    summary: 'Treasury yield engine operational. dSOL staking live, Maple ready for USDC.',
    fixedIssues: [
      'Squads multi-sig treasury created',
      'dSOL staking live (1.004 dSOL @ 6.74% APY)',
      'treasury-live edge function deployed',
      'Real-time on-chain balance tracking'
    ],
    openIssues: [
      { text: 'Bridge KYB pending (submitted Feb 6)', severity: 'blocked', note: 'Expected ~Feb 13' },
      { text: 'Maple/Kamino/MarginFi diversification', severity: 'waiting', note: 'Needs USDC from Bridge' }
    ]
  },
  {
    id: 'edge-functions',
    name: 'Edge Functions',
    date: '2026-02-05',
    status: 'pass',
    grade: '‚úÖ',
    summary: 'All 27 functions deployed. Security issues fixed.',
    fixedIssues: [
      'oxo-status POST now requires admin auth',
      'kraken-buy-usdc requires auth + has limits',
      'kraken-withdraw requires auth + limits',
      'analytics-status user_id bug fixed',
      'APY rates now show source/live status',
      'treasury-live added for on-chain data'
    ],
    openIssues: []
  },
  {
    id: 'dataflow',
    name: 'Data Flow',
    date: '2026-02-05',
    status: 'partial',
    grade: 'üü°',
    summary: 'Stripe ‚Üí Treasury working. External integrations pending.',
    fixedIssues: [
      'Stripe webhook treasury integration',
      'yield-distribution edge function created'
    ],
    openIssues: [
      { text: 'Mercury bank API not integrated', severity: 'low', note: 'Manual for now, API access available' },
      { text: 'Staking protocol SDKs not integrated', severity: 'low', note: 'Using Squads UI for manual staking' }
    ]
  },
  {
    id: 'database',
    name: 'Database Schema',
    date: '2026-02-05',
    status: 'warning',
    grade: 'üü°',
    summary: 'Functional but has tech debt. Not blocking pilot.',
    fixedIssues: [
      'Treasury tables properly linked',
      'RLS policies reviewed'
    ],
    openIssues: [
      { text: 'Dual user system (users vs profiles)', severity: 'tech-debt', note: 'Works but messy' },
      { text: 'Dual merchant system', severity: 'tech-debt', note: 'Works but messy' },
      { text: '12+ tables reference deprecated users table', severity: 'tech-debt', note: 'Migration needed post-pilot' }
    ]
  },
  {
    id: 'treasury-math',
    name: 'Treasury Math',
    date: '2026-02-05',
    status: 'pass',
    grade: '‚úÖ',
    summary: 'Core yield distribution formulas verified correct.',
    fixedIssues: [
      'Pro-rata yield distribution',
      'APY calculation formulas',
      'Pool share tracking'
    ],
    openIssues: []
  },
  {
    id: 'user-app',
    name: 'User App',
    date: '2026-02-06',
    status: 'pass',
    grade: '‚úÖ',
    summary: 'Feature complete. All screens wired to Supabase.',
    fixedIssues: [
      'All settings screens connected to real data',
      'Avatar upload working',
      'Referral system implemented',
      'Achievement badges (17) deployed',
      'Offline caching added',
      'Real-time updates via Supabase Realtime'
    ],
    openIssues: [
      { text: 'iOS/Android builds pending', severity: 'blocked', note: 'Waiting on Apple Developer approval' }
    ]
  }
];

// Calculate stats
const totalFixed = audits.reduce((sum, a) => sum + a.fixedIssues.length, 0);
const openIssues = audits.flatMap(a => a.openIssues);
const criticalOpen = openIssues.filter(i => i.severity === 'critical').length;
const blockedOpen = openIssues.filter(i => i.severity === 'blocked').length;
const techDebtOpen = openIssues.filter(i => i.severity === 'tech-debt').length;
const lowOpen = openIssues.filter(i => i.severity === 'low' || i.severity === 'waiting').length;

const getStatusColor = (status: string) => {
  switch (status) {
    case 'pass': return 'bg-green-500/20 text-green-400 border-green-500/30';
    case 'partial': return 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30';
    case 'warning': return 'bg-orange-500/20 text-orange-400 border-orange-500/30';
    case 'fail': return 'bg-red-500/20 text-red-400 border-red-500/30';
    default: return 'bg-slate-500/20 text-slate-400 border-slate-500/30';
  }
};

const getSeverityColor = (severity: string) => {
  switch (severity) {
    case 'critical': return 'text-red-400';
    case 'blocked': return 'text-orange-400';
    case 'tech-debt': return 'text-yellow-400';
    case 'low': return 'text-slate-400';
    case 'waiting': return 'text-blue-400';
    default: return 'text-slate-400';
  }
};

const getSeverityBadge = (severity: string) => {
  switch (severity) {
    case 'critical': return 'bg-red-500/20 text-red-400 border-red-500/30';
    case 'blocked': return 'bg-orange-500/20 text-orange-400 border-orange-500/30';
    case 'tech-debt': return 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30';
    case 'low': return 'bg-slate-500/20 text-slate-400 border-slate-500/30';
    case 'waiting': return 'bg-blue-500/20 text-blue-400 border-blue-500/30';
    default: return 'bg-slate-500/20 text-slate-400 border-slate-500/30';
  }
};
---

<DashboardLayout title="System Health - Loop Command Center" active="system-health">
  <div class="p-6 space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
      <div>
        <h1 class="text-xl sm:text-2xl font-bold text-white">System Health</h1>
        <p class="text-slate-400 text-sm mt-1">Audits, diagnostics, and infrastructure status</p>
      </div>
      <div class="text-sm text-slate-400">
        Last updated: Feb 9, 2026
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 sm:gap-4">
      <div class="bg-slate-800 rounded-xl p-3 sm:p-4 border border-slate-700">
        <div class="text-slate-400 text-xs sm:text-sm">Audits</div>
        <div class="text-xl sm:text-2xl font-bold text-white mt-1">{audits.length}</div>
        <div class="text-xs text-green-400 mt-1">{audits.filter(a => a.status === 'pass').length} passing</div>
      </div>
      <div class="bg-slate-800 rounded-xl p-3 sm:p-4 border border-green-500/30">
        <div class="text-slate-400 text-xs sm:text-sm">Fixed</div>
        <div class="text-xl sm:text-2xl font-bold text-green-400 mt-1">{totalFixed}</div>
        <div class="text-xs text-slate-400 mt-1">issues resolved</div>
      </div>
      <div class="bg-slate-800 rounded-xl p-3 sm:p-4 border border-orange-500/30">
        <div class="text-slate-400 text-xs sm:text-sm">Blocked</div>
        <div class="text-xl sm:text-2xl font-bold text-orange-400 mt-1">{blockedOpen}</div>
        <div class="text-xs text-slate-400 mt-1">waiting on external</div>
      </div>
      <div class="bg-slate-800 rounded-xl p-3 sm:p-4 border border-yellow-500/30">
        <div class="text-slate-400 text-xs sm:text-sm">Tech Debt</div>
        <div class="text-xl sm:text-2xl font-bold text-yellow-400 mt-1">{techDebtOpen}</div>
        <div class="text-xs text-slate-400 mt-1">non-blocking</div>
      </div>
      <div class="bg-slate-800 rounded-xl p-3 sm:p-4 border border-slate-700">
        <div class="text-slate-400 text-xs sm:text-sm">Low Priority</div>
        <div class="text-xl sm:text-2xl font-bold text-slate-400 mt-1">{lowOpen}</div>
        <div class="text-xs text-slate-400 mt-1">can wait</div>
      </div>
    </div>

    <!-- Overall Status Banner -->
    <div class="bg-gradient-to-r from-green-500/10 to-emerald-500/10 border border-green-500/30 rounded-xl p-4">
      <div class="flex items-center gap-3">
        <span class="text-3xl">‚úÖ</span>
        <div>
          <h3 class="text-lg font-semibold text-green-400">System Ready for Pilot</h3>
          <p class="text-slate-400 text-sm">No critical blockers. Treasury live. App complete. Waiting on Bridge KYB.</p>
        </div>
      </div>
    </div>

    <!-- Audit Results -->
    <div class="bg-slate-800 rounded-xl border border-slate-700">
      <div class="p-4 border-b border-slate-700">
        <h2 class="text-lg font-semibold text-white">Audit Results</h2>
      </div>
      
      <div class="divide-y divide-slate-700">
        {audits.map(audit => (
          <div class="p-4 hover:bg-slate-700/30 transition-colors">
            <div class="flex items-start justify-between mb-3">
              <div class="flex items-center gap-3">
                <span class="text-xl">{audit.grade}</span>
                <h3 class="font-medium text-white">{audit.name}</h3>
                <span class={`text-xs px-2 py-0.5 rounded-full border ${getStatusColor(audit.status)}`}>
                  {audit.status}
                </span>
              </div>
              <span class="text-sm text-slate-500">{audit.date}</span>
            </div>
            
            <p class="text-sm text-slate-400 mb-3">{audit.summary}</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Fixed Issues -->
              {audit.fixedIssues.length > 0 && (
                <div>
                  <div class="text-xs font-medium text-green-400 mb-2">‚úÖ Fixed ({audit.fixedIssues.length})</div>
                  <ul class="text-xs text-slate-500 space-y-1">
                    {audit.fixedIssues.map(issue => (
                      <li class="flex items-start gap-2">
                        <span class="text-green-500">‚úì</span>
                        <span class="line-through opacity-60">{issue}</span>
                      </li>
                    ))}
                  </ul>
                </div>
              )}
              
              <!-- Open Issues -->
              {audit.openIssues.length > 0 && (
                <div>
                  <div class="text-xs font-medium text-orange-400 mb-2">‚è≥ Open ({audit.openIssues.length})</div>
                  <ul class="text-xs space-y-2">
                    {audit.openIssues.map(issue => (
                      <li class="flex items-start gap-2">
                        <span class={getSeverityColor(issue.severity)}>‚Ä¢</span>
                        <div>
                          <span class="text-slate-300">{issue.text}</span>
                          <span class={`ml-2 px-1.5 py-0.5 rounded text-[10px] border ${getSeverityBadge(issue.severity)}`}>
                            {issue.severity}
                          </span>
                          {issue.note && <div class="text-slate-500 mt-0.5">{issue.note}</div>}
                        </div>
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>
          </div>
        ))}
      </div>
    </div>

    <!-- Infrastructure Status -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Services -->
      <div class="bg-slate-800 rounded-xl border border-slate-700">
        <div class="p-4 border-b border-slate-700">
          <h2 class="text-lg font-semibold text-white">External Services</h2>
        </div>
        <div class="p-4 space-y-3">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="w-2 h-2 bg-green-500 rounded-full"></span>
              <span class="text-slate-300">Supabase</span>
            </div>
            <span class="text-xs text-green-400">Connected</span>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="w-2 h-2 bg-green-500 rounded-full"></span>
              <span class="text-slate-300">Stripe</span>
            </div>
            <span class="text-xs text-green-400">Live Mode</span>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="w-2 h-2 bg-green-500 rounded-full"></span>
              <span class="text-slate-300">Squads (Solana)</span>
            </div>
            <span class="text-xs text-green-400">Vault Active</span>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="w-2 h-2 bg-green-500 rounded-full"></span>
              <span class="text-slate-300">Drift (dSOL)</span>
            </div>
            <span class="text-xs text-green-400">Staking Live</span>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></span>
              <span class="text-slate-300">Bridge</span>
            </div>
            <span class="text-xs text-yellow-400">KYB Pending (~Feb 13)</span>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
              <span class="text-slate-300">Maple Finance</span>
            </div>
            <span class="text-xs text-blue-400">Ready (needs USDC)</span>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="w-2 h-2 bg-yellow-500 rounded-full"></span>
              <span class="text-slate-300">Kraken</span>
            </div>
            <span class="text-xs text-yellow-400">API Ready (deposits pending)</span>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="w-2 h-2 bg-slate-500 rounded-full"></span>
              <span class="text-slate-300">Mercury Bank</span>
            </div>
            <span class="text-xs text-slate-400">Manual (no API yet)</span>
          </div>
        </div>
      </div>

      <!-- Deployments -->
      <div class="bg-slate-800 rounded-xl border border-slate-700">
        <div class="p-4 border-b border-slate-700">
          <h2 class="text-lg font-semibold text-white">Deployments</h2>
        </div>
        <div class="p-4 space-y-3">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="w-2 h-2 bg-green-500 rounded-full"></span>
              <span class="text-slate-300">User App</span>
            </div>
            <a href="https://app.looplocal.io" class="text-xs text-emerald-400 hover:text-emerald-300">app.looplocal.io ‚Üó</a>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="w-2 h-2 bg-green-500 rounded-full"></span>
              <span class="text-slate-300">Merchant App</span>
            </div>
            <a href="https://merchant.looplocal.io" class="text-xs text-emerald-400 hover:text-emerald-300">merchant.looplocal.io ‚Üó</a>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="w-2 h-2 bg-green-500 rounded-full"></span>
              <span class="text-slate-300">Command Center</span>
            </div>
            <a href="https://command.looplocal.io" class="text-xs text-emerald-400 hover:text-emerald-300">command.looplocal.io ‚Üó</a>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="w-2 h-2 bg-green-500 rounded-full"></span>
              <span class="text-slate-300">Marketing Site</span>
            </div>
            <a href="https://looplocal.io" class="text-xs text-emerald-400 hover:text-emerald-300">looplocal.io ‚Üó</a>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="w-2 h-2 bg-green-500 rounded-full"></span>
              <span class="text-slate-300">Edge Functions</span>
            </div>
            <span class="text-xs text-green-400">27 deployed</span>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="w-2 h-2 bg-green-500 rounded-full"></span>
              <span class="text-slate-300">Database</span>
            </div>
            <span class="text-xs text-green-400">62 tables</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Blockers Section -->
    <div class="bg-slate-800 rounded-xl border border-orange-500/30">
      <div class="p-4 border-b border-slate-700">
        <h2 class="text-lg font-semibold text-orange-400">‚è≥ External Blockers</h2>
        <p class="text-sm text-slate-400">Waiting on third parties</p>
      </div>
      <div class="p-4 space-y-3">
        <div class="flex items-start gap-3 p-3 bg-orange-500/10 rounded-lg border border-orange-500/20">
          <span class="text-orange-400 font-bold mt-0.5">1</span>
          <div class="flex-1">
            <div class="font-medium text-white">Bridge KYB Approval</div>
            <div class="text-sm text-slate-400">Submitted Feb 6 ‚Äî Expected ~Feb 13</div>
            <div class="text-xs text-orange-400 mt-1">Blocks: USDC funding ‚Üí Maple/Kamino deposits</div>
          </div>
        </div>
        <div class="flex items-start gap-3 p-3 bg-orange-500/10 rounded-lg border border-orange-500/20">
          <span class="text-orange-400 font-bold mt-0.5">2</span>
          <div class="flex-1">
            <div class="font-medium text-white">Apple Developer Account</div>
            <div class="text-sm text-slate-400">Enrollment pending ‚Äî Up to 48h</div>
            <div class="text-xs text-orange-400 mt-1">Blocks: iOS/Android native builds</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Audit Files -->
    <div class="bg-slate-800 rounded-xl border border-slate-700">
      <div class="p-4 border-b border-slate-700">
        <h2 class="text-lg font-semibold text-white">Detailed Reports</h2>
      </div>
      <div class="p-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="flex items-center gap-3 p-3 bg-slate-700/50 rounded-lg">
            <span>üìÑ</span>
            <div class="flex-1">
              <div class="text-sm font-medium text-white">Infrastructure Audit</div>
              <div class="text-xs text-slate-400">loop/INFRASTRUCTURE-AUDIT.md</div>
            </div>
          </div>
          <div class="flex items-center gap-3 p-3 bg-slate-700/50 rounded-lg">
            <span>üìÑ</span>
            <div class="flex-1">
              <div class="text-sm font-medium text-white">Vision Document</div>
              <div class="text-xs text-slate-400">loop/VISION.md</div>
            </div>
          </div>
          <div class="flex items-center gap-3 p-3 bg-slate-700/50 rounded-lg">
            <span>üìÑ</span>
            <div class="flex-1">
              <div class="text-sm font-medium text-white">Data Flow Audit</div>
              <div class="text-xs text-slate-400">memory/2026-02-05-audit-dataflow.md</div>
            </div>
          </div>
          <div class="flex items-center gap-3 p-3 bg-slate-700/50 rounded-lg">
            <span>üìÑ</span>
            <div class="flex-1">
              <div class="text-sm font-medium text-white">Database Schema Audit</div>
              <div class="text-xs text-slate-400">memory/2026-02-05-audit-database.md</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</DashboardLayout>
