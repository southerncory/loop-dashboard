---
import DashboardLayout from '../layouts/DashboardLayout.astro';

// Audit data - in the future this could come from an edge function or database
const audits = [
  {
    id: 'dataflow',
    name: 'Data Flow',
    date: '2026-02-05',
    status: 'partial',
    grade: 'ðŸŸ¡',
    summary: 'Stripe â†’ Treasury integration FIXED. Mercury and staking still need work.',
    criticalIssues: [
      'âœ… FIXED: Stripe webhook treasury integration',
      'âœ… FIXED: yield-distribution edge function created',
      'Mercury bank - no API integration (needs API access)',
      'Staking protocols not implemented (needs SDK work)'
    ],
    findings: 4
  },
  {
    id: 'edge-functions',
    name: 'Edge Functions',
    date: '2026-02-05',
    status: 'pass',
    grade: 'âœ…',
    summary: 'All critical auth issues FIXED. Functions secured.',
    criticalIssues: [
      'âœ… FIXED: oxo-status POST now requires admin auth',
      'âœ… FIXED: kraken-buy-usdc requires auth + has limits',
      'âœ… FIXED: kraken-withdraw requires auth + limits',
      'âœ… FIXED: analytics-status user_id bug',
      'âœ… FIXED: APY rates now show source/live status'
    ],
    findings: 7
  },
  {
    id: 'database',
    name: 'Database Schema',
    date: '2026-02-05',
    status: 'warning',
    grade: 'ðŸŸ¡',
    summary: 'Treasury tables properly linked. Tech debt from dual user/merchant systems.',
    criticalIssues: [
      'Dual user system (users vs profiles)',
      'Dual merchant system (merchants vs merchant_profiles)',
      '12+ tables reference deprecated users table',
      'Some RLS policies overly permissive'
    ],
    findings: 5
  },
  {
    id: 'treasury-math',
    name: 'Treasury Math',
    date: '2026-02-05',
    status: 'pass',
    grade: 'âœ…',
    summary: 'Core yield distribution formulas verified correct.',
    criticalIssues: [],
    findings: 3
  }
];

const getStatusColor = (status: string) => {
  switch (status) {
    case 'pass': return 'bg-green-500/20 text-green-400 border-green-500/30';
    case 'partial': return 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30';
    case 'warning': return 'bg-orange-500/20 text-orange-400 border-orange-500/30';
    case 'fail': return 'bg-red-500/20 text-red-400 border-red-500/30';
    default: return 'bg-slate-500/20 text-slate-400 border-slate-500/30';
  }
};

const getStatusLabel = (status: string) => {
  switch (status) {
    case 'pass': return 'Passed';
    case 'partial': return 'Partial';
    case 'warning': return 'Warning';
    case 'fail': return 'Failed';
    default: return 'Unknown';
  }
};
---

<DashboardLayout title="System Health - Loop Command Center" active="system-health">
  <div class="p-6 space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
      <div>
        <h1 class="text-xl sm:text-2xl font-bold text-white">System Health</h1>
        <p class="text-slate-400 text-sm mt-1">Audits, diagnostics, and infrastructure status</p>
      </div>
      <button id="run-audits-btn" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium transition-colors flex items-center gap-2 text-sm">
        <span>ðŸ”„</span>
        Run Audits
      </button>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4">
      <div class="bg-slate-800 rounded-xl p-3 sm:p-4 border border-slate-700">
        <div class="text-slate-400 text-xs sm:text-sm">Total Audits</div>
        <div class="text-xl sm:text-2xl font-bold text-white mt-1">{audits.length}</div>
      </div>
      <div class="bg-slate-800 rounded-xl p-3 sm:p-4 border border-slate-700">
        <div class="text-slate-400 text-xs sm:text-sm">Passing</div>
        <div class="text-xl sm:text-2xl font-bold text-green-400 mt-1">{audits.filter(a => a.status === 'pass').length}</div>
      </div>
      <div class="bg-slate-800 rounded-xl p-3 sm:p-4 border border-slate-700">
        <div class="text-slate-400 text-xs sm:text-sm">Warnings</div>
        <div class="text-xl sm:text-2xl font-bold text-yellow-400 mt-1">{audits.filter(a => a.status === 'warning' || a.status === 'partial').length}</div>
      </div>
      <div class="bg-slate-800 rounded-xl p-3 sm:p-4 border border-slate-700">
        <div class="text-slate-400 text-xs sm:text-sm">Critical Issues</div>
        <div class="text-xl sm:text-2xl font-bold text-red-400 mt-1">{audits.reduce((sum, a) => sum + a.criticalIssues.length, 0)}</div>
      </div>
    </div>

    <!-- Audit Results -->
    <div class="bg-slate-800 rounded-xl border border-slate-700">
      <div class="p-4 border-b border-slate-700">
        <h2 class="text-lg font-semibold text-white">Latest Audits</h2>
        <p class="text-sm text-slate-400">Last run: February 5, 2026</p>
      </div>
      
      <div class="divide-y divide-slate-700">
        {audits.map(audit => (
          <div class="p-4 hover:bg-slate-700/30 transition-colors">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div class="flex items-center gap-3">
                  <span class="text-xl">{audit.grade}</span>
                  <h3 class="font-medium text-white">{audit.name}</h3>
                  <span class={`text-xs px-2 py-0.5 rounded-full border ${getStatusColor(audit.status)}`}>
                    {getStatusLabel(audit.status)}
                  </span>
                </div>
                <p class="text-sm text-slate-400 mt-1">{audit.summary}</p>
                
                {audit.criticalIssues.length > 0 && (
                  <div class="mt-3">
                    <div class="text-xs font-medium text-red-400 mb-1">Critical Issues:</div>
                    <ul class="text-xs text-slate-400 space-y-1">
                      {audit.criticalIssues.map(issue => (
                        <li class="flex items-start gap-2">
                          <span class="text-red-400">â€¢</span>
                          <span>{issue}</span>
                        </li>
                      ))}
                    </ul>
                  </div>
                )}
              </div>
              <div class="text-right text-sm text-slate-500">
                <div>{audit.date}</div>
                <div>{audit.findings} findings</div>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>

    <!-- Infrastructure Status -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Services -->
      <div class="bg-slate-800 rounded-xl border border-slate-700">
        <div class="p-4 border-b border-slate-700">
          <h2 class="text-lg font-semibold text-white">Services</h2>
        </div>
        <div class="p-4 space-y-3">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="w-2 h-2 bg-green-500 rounded-full"></span>
              <span class="text-slate-300">Supabase</span>
            </div>
            <span class="text-xs text-green-400">Connected</span>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="w-2 h-2 bg-green-500 rounded-full"></span>
              <span class="text-slate-300">Stripe</span>
            </div>
            <span class="text-xs text-green-400">Active</span>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="w-2 h-2 bg-yellow-500 rounded-full"></span>
              <span class="text-slate-300">Kraken</span>
            </div>
            <span class="text-xs text-yellow-400">API Ready (Deposits Pending)</span>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="w-2 h-2 bg-green-500 rounded-full"></span>
              <span class="text-slate-300">Solana RPC</span>
            </div>
            <span class="text-xs text-green-400">Mainnet</span>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="w-2 h-2 bg-slate-500 rounded-full"></span>
              <span class="text-slate-300">Mercury Bank</span>
            </div>
            <span class="text-xs text-slate-400">Not Integrated</span>
          </div>
        </div>
      </div>

      <!-- Edge Functions -->
      <div class="bg-slate-800 rounded-xl border border-slate-700">
        <div class="p-4 border-b border-slate-700">
          <h2 class="text-lg font-semibold text-white">Edge Functions</h2>
        </div>
        <div class="p-4">
          <div class="grid grid-cols-2 gap-2 text-xs">
            <div class="flex items-center gap-2 text-slate-300">
              <span class="text-green-400">âœ“</span> dashboard-status
            </div>
            <div class="flex items-center gap-2 text-slate-300">
              <span class="text-green-400">âœ“</span> analytics-status
            </div>
            <div class="flex items-center gap-2 text-slate-300">
              <span class="text-green-400">âœ“</span> loops-status
            </div>
            <div class="flex items-center gap-2 text-slate-300">
              <span class="text-green-400">âœ“</span> treasury-status
            </div>
            <div class="flex items-center gap-2 text-slate-300">
              <span class="text-green-400">âœ“</span> merchants-status
            </div>
            <div class="flex items-center gap-2 text-slate-300">
              <span class="text-green-400">âœ“</span> users-status
            </div>
            <div class="flex items-center gap-2 text-slate-300">
              <span class="text-green-400">âœ“</span> settings-status
            </div>
            <div class="flex items-center gap-2 text-slate-300">
              <span class="text-green-400">âœ“</span> support-tickets
            </div>
            <div class="flex items-center gap-2 text-slate-300">
              <span class="text-green-400">âœ“</span> oxo-status
            </div>
            <div class="flex items-center gap-2 text-slate-300">
              <span class="text-green-400">âœ“</span> kraken-buy-usdc
            </div>
            <div class="flex items-center gap-2 text-slate-300">
              <span class="text-green-400">âœ“</span> kraken-withdraw
            </div>
            <div class="flex items-center gap-2 text-slate-300">
              <span class="text-green-400">âœ“</span> stripe-webhook
            </div>
            <div class="flex items-center gap-2 text-slate-300">
              <span class="text-green-400">âœ“</span> yield-distribution
            </div>
          </div>
          <div class="mt-3 pt-3 border-t border-slate-700 text-xs text-slate-400">
            <span class="text-green-400">âœ“</span> Working &nbsp;
            <span class="text-yellow-400">âš </span> Auth Issue &nbsp;
            <span class="text-red-400">âœ—</span> Missing
          </div>
        </div>
      </div>
    </div>

    <!-- Action Items -->
    <div class="bg-slate-800 rounded-xl border border-slate-700">
      <div class="p-4 border-b border-slate-700">
        <h2 class="text-lg font-semibold text-white">Priority Fixes</h2>
        <p class="text-sm text-slate-400">Updated: Feb 5, 2026</p>
      </div>
      <div class="p-4">
        <div class="space-y-3">
          <div class="flex items-start gap-3 p-3 bg-green-500/10 rounded-lg border border-green-500/20">
            <span class="text-green-400 font-bold">âœ“</span>
            <div>
              <div class="font-medium text-white line-through opacity-60">Add auth to oxo-status POST actions</div>
              <div class="text-sm text-green-400">FIXED: Admin-only auth with email allowlist</div>
            </div>
          </div>
          <div class="flex items-start gap-3 p-3 bg-green-500/10 rounded-lg border border-green-500/20">
            <span class="text-green-400 font-bold">âœ“</span>
            <div>
              <div class="font-medium text-white line-through opacity-60">Add auth to Kraken functions</div>
              <div class="text-sm text-green-400">FIXED: Auth + amount limits ($10k buy, $25k withdraw)</div>
            </div>
          </div>
          <div class="flex items-start gap-3 p-3 bg-green-500/10 rounded-lg border border-green-500/20">
            <span class="text-green-400 font-bold">âœ“</span>
            <div>
              <div class="font-medium text-white line-through opacity-60">Create yield-distribution edge function</div>
              <div class="text-sm text-green-400">FIXED: Created and deployed with idempotency checks</div>
            </div>
          </div>
          <div class="flex items-start gap-3 p-3 bg-green-500/10 rounded-lg border border-green-500/20">
            <span class="text-green-400 font-bold">âœ“</span>
            <div>
              <div class="font-medium text-white line-through opacity-60">Fix stripe-webhook treasury integration</div>
              <div class="text-sm text-green-400">FIXED: Now creates treasury_transactions and merchant_pool_shares</div>
            </div>
          </div>
          
          <div class="mt-4 pt-4 border-t border-slate-700">
            <h3 class="text-sm font-medium text-slate-300 mb-3">Remaining (Requires External Work)</h3>
          </div>
          
          <div class="flex items-start gap-3 p-3 bg-slate-700/30 rounded-lg border border-slate-600/30">
            <span class="text-slate-400 font-bold">â€”</span>
            <div>
              <div class="font-medium text-white">Mercury bank API integration</div>
              <div class="text-sm text-slate-400">Needs Mercury API access to sync balances</div>
            </div>
          </div>
          <div class="flex items-start gap-3 p-3 bg-slate-700/30 rounded-lg border border-slate-600/30">
            <span class="text-slate-400 font-bold">â€”</span>
            <div>
              <div class="font-medium text-white">Staking protocol integrations</div>
              <div class="text-sm text-slate-400">Needs Marinade/Jito/Kamino SDK work for actual staking</div>
            </div>
          </div>
          <div class="flex items-start gap-3 p-3 bg-slate-700/30 rounded-lg border border-slate-600/30">
            <span class="text-slate-400 font-bold">â€”</span>
            <div>
              <div class="font-medium text-white">Database schema consolidation</div>
              <div class="text-sm text-slate-400">Tech debt: Dual user/merchant systems need migration</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Audit Files -->
    <div class="bg-slate-800 rounded-xl border border-slate-700">
      <div class="p-4 border-b border-slate-700">
        <h2 class="text-lg font-semibold text-white">Detailed Reports</h2>
        <p class="text-sm text-slate-400">Full audit documentation</p>
      </div>
      <div class="p-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="flex items-center gap-3 p-3 bg-slate-700/50 rounded-lg">
            <span>ðŸ“„</span>
            <div class="flex-1">
              <div class="text-sm font-medium text-white">Data Flow Audit</div>
              <div class="text-xs text-slate-400">memory/2026-02-05-audit-dataflow.md</div>
            </div>
          </div>
          <div class="flex items-center gap-3 p-3 bg-slate-700/50 rounded-lg">
            <span>ðŸ“„</span>
            <div class="flex-1">
              <div class="text-sm font-medium text-white">Edge Functions Audit</div>
              <div class="text-xs text-slate-400">memory/2026-02-05-audit-edge-functions.md</div>
            </div>
          </div>
          <div class="flex items-center gap-3 p-3 bg-slate-700/50 rounded-lg">
            <span>ðŸ“„</span>
            <div class="flex-1">
              <div class="text-sm font-medium text-white">Database Schema Audit</div>
              <div class="text-xs text-slate-400">memory/2026-02-05-audit-database.md</div>
            </div>
          </div>
          <div class="flex items-center gap-3 p-3 bg-slate-700/50 rounded-lg">
            <span>ðŸ“„</span>
            <div class="flex-1">
              <div class="text-sm font-medium text-white">Treasury Math Audit</div>
              <div class="text-xs text-slate-400">memory/2026-02-05-audit-treasury-math.md</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.getElementById('run-audits-btn')?.addEventListener('click', () => {
      alert('Audit scheduling will be available soon. For now, ask Burt to run audits via WhatsApp.');
    });
  </script>
</DashboardLayout>
