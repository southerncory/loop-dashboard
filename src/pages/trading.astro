---
import DashboardLayout from '../layouts/DashboardLayout.astro';
import StatusDot from '../components/ui/StatusDot.astro';
import Badge from '../components/ui/Badge.astro';

// Primary data source: Supabase (synced from A9 bridge every 30 min)
const supabaseUrl = 'https://ibhjsutgxhujbjhrilwx.supabase.co';
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImliaGpzdXRneGh1amJqaHJpbHd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzNzkzODgsImV4cCI6MjA4NDk1NTM4OH0.5BWyde9ozVjf9KV-se6o0g6zf2MBWlUWU6pN98KaOO4';
---

<DashboardLayout title="Trading | Loop" active="trading">
  <div class="min-h-screen bg-[#0f1419] p-4 md:p-6 space-y-4">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
      <div>
        <h1 class="text-xl font-semibold text-slate-100">Trading</h1>
        <p class="text-slate-500 text-sm mt-0.5">APEX PREDATOR v3.0 + Scalper</p>
      </div>
      <div class="flex items-center gap-3">
        <div id="connection-status" class="flex items-center gap-2 text-sm">
          <span class="w-1.5 h-1.5 rounded-full bg-slate-600"></span>
          <span class="text-slate-500">Connecting...</span>
        </div>
        <button id="refresh-btn" class="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 border border-slate-700/50 rounded text-sm text-slate-300 transition-colors">
          Refresh
        </button>
      </div>
    </div>

    <!-- Control Bar -->
    <div class="bg-[#1a2028] rounded-lg border border-slate-700/50 p-3">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div class="flex items-center gap-4">
          <div class="flex items-center gap-2">
            <span class="text-xs text-slate-500 uppercase tracking-wide">Trading</span>
            <button id="pause-toggle" class="relative w-12 h-6 rounded-full bg-slate-700 transition-colors">
              <span id="pause-toggle-dot" class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-slate-400 transition-transform"></span>
            </button>
            <span id="pause-label" class="text-sm text-slate-400">--</span>
          </div>
          <div class="h-5 w-px bg-slate-700"></div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-slate-500 uppercase tracking-wide">Mode</span>
            <span id="survival-badge" class="px-2 py-0.5 rounded text-xs font-medium bg-slate-700 text-slate-400">--</span>
          </div>
        </div>
        <span id="last-update" class="text-xs text-slate-600 font-mono">--</span>
      </div>
    </div>

    <!-- Stats Row -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
      <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg p-3">
        <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">Total P&L</div>
        <div id="total-pnl" class="text-xl font-semibold font-mono text-slate-200">--</div>
        <div id="total-pnl-pct" class="text-xs text-slate-600 font-mono mt-0.5">--%</div>
      </div>
      <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg p-3">
        <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">Today</div>
        <div id="today-pnl" class="text-xl font-semibold font-mono text-slate-200">--</div>
        <div id="today-trades" class="text-xs text-slate-600 mt-0.5">-- trades</div>
      </div>
      <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg p-3">
        <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">Win Rate</div>
        <div id="win-rate" class="text-xl font-semibold font-mono text-slate-200">--%</div>
        <div id="trade-count" class="text-xs text-slate-600 mt-0.5">-- trades</div>
      </div>
      <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg p-3">
        <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">Open</div>
        <div id="open-count" class="text-xl font-semibold font-mono text-slate-200">0</div>
        <div id="open-pnl" class="text-xs text-slate-600 mt-0.5">$0 unrealized</div>
      </div>
      <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg p-3">
        <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">Fear & Greed</div>
        <div id="fear-greed" class="text-xl font-semibold font-mono text-slate-200">--</div>
        <div id="market-regime" class="text-xs text-slate-600 mt-0.5">--</div>
      </div>
    </div>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <!-- Open Positions -->
      <div class="lg:col-span-2 bg-[#1a2028] border border-slate-700/50 rounded-lg">
        <div class="p-3 border-b border-slate-700/50 flex items-center justify-between">
          <h2 class="text-sm font-medium text-slate-200">Open Positions</h2>
          <span id="position-label" class="text-xs text-slate-500">--</span>
        </div>
        <div id="positions-container" class="p-4">
          <div class="text-center py-6 text-slate-600 text-sm">
            No open positions
          </div>
        </div>
      </div>

      <!-- Services -->
      <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg">
        <div class="p-3 border-b border-slate-700/50">
          <h2 class="text-sm font-medium text-slate-200">Services</h2>
        </div>
        <div class="p-3 space-y-2">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <div id="svc-freqtrade" class="w-2 h-2 rounded-full bg-slate-600"></div>
              <span class="text-sm text-slate-300">FreqTrade</span>
            </div>
            <span id="svc-freqtrade-label" class="text-xs text-slate-500 font-mono">--</span>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <div id="svc-ollama" class="w-2 h-2 rounded-full bg-slate-600"></div>
              <span class="text-sm text-slate-300">Ollama LLM</span>
            </div>
            <span id="svc-ollama-label" class="text-xs text-slate-500 font-mono">--</span>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <div id="svc-bridge" class="w-2 h-2 rounded-full bg-slate-600"></div>
              <span class="text-sm text-slate-300">Bridge API</span>
            </div>
            <span id="svc-bridge-label" class="text-xs text-slate-500 font-mono">--</span>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <div id="svc-reconciler" class="w-2 h-2 rounded-full bg-slate-600"></div>
              <span class="text-sm text-slate-300">Reconciler</span>
            </div>
            <span id="svc-reconciler-label" class="text-xs text-slate-500 font-mono">--</span>
          </div>
        </div>
        
        <div class="p-3 border-t border-slate-700/50">
          <div class="flex items-center justify-between mb-2">
            <span class="text-xs text-slate-500 uppercase tracking-wide">DLQ</span>
            <button id="process-dlq" class="text-xs px-2 py-0.5 bg-slate-700 hover:bg-slate-600 rounded text-slate-300">Process</button>
          </div>
          <div class="flex items-center gap-4 text-xs">
            <div><span class="text-slate-500">Pending:</span> <span id="dlq-pending" class="text-slate-300 font-mono">--</span></div>
            <div><span class="text-slate-500">Failed:</span> <span id="dlq-failed" class="text-slate-300 font-mono">--</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <!-- Signals -->
      <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg">
        <div class="p-3 border-b border-slate-700/50 flex items-center justify-between">
          <h2 class="text-sm font-medium text-slate-200">Recent Signals</h2>
          <span class="text-xs text-slate-500">Last 10</span>
        </div>
        <div id="signals-container" class="divide-y divide-slate-700/30 max-h-64 overflow-y-auto">
          <div class="p-4 text-center text-slate-600 text-sm">Loading...</div>
        </div>
      </div>

      <!-- Trades -->
      <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg">
        <div class="p-3 border-b border-slate-700/50 flex items-center justify-between">
          <h2 class="text-sm font-medium text-slate-200">Recent Trades</h2>
          <span class="text-xs text-slate-500">Last 10</span>
        </div>
        <div id="trades-container" class="divide-y divide-slate-700/30 max-h-64 overflow-y-auto">
          <div class="p-4 text-center text-slate-600 text-sm">Loading...</div>
        </div>
      </div>
    </div>

    <!-- Daily Chart -->
    <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg">
      <div class="p-3 border-b border-slate-700/50 flex items-center justify-between">
        <h2 class="text-sm font-medium text-slate-200">Daily Performance</h2>
        <span class="text-xs text-slate-500">Last 14 days</span>
      </div>
      <div class="p-4">
        <div id="daily-chart" class="h-32 flex items-end gap-1"></div>
      </div>
    </div>

    <!-- Architecture -->
    <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg p-4">
      <h2 class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-3">Architecture</h2>
      <div class="flex flex-wrap items-center justify-center gap-3 text-sm">
        <div class="bg-emerald-500/10 border border-emerald-500/20 rounded px-3 py-1.5 text-center">
          <div class="font-medium text-emerald-400 text-xs">OpenClaw</div>
          <div class="text-xs text-slate-500">Brain</div>
        </div>
        <span class="text-slate-600">→</span>
        <div class="bg-blue-500/10 border border-blue-500/20 rounded px-3 py-1.5 text-center">
          <div class="font-medium text-blue-400 text-xs">Bridge</div>
          <div class="text-xs text-slate-500">Validator</div>
        </div>
        <span class="text-slate-600">→</span>
        <div class="bg-purple-500/10 border border-purple-500/20 rounded px-3 py-1.5 text-center">
          <div class="font-medium text-purple-400 text-xs">Ollama</div>
          <div class="text-xs text-slate-500">LLM</div>
        </div>
        <span class="text-slate-600">→</span>
        <div class="bg-amber-500/10 border border-amber-500/20 rounded px-3 py-1.5 text-center">
          <div class="font-medium text-amber-400 text-xs">FreqTrade</div>
          <div class="text-xs text-slate-500">Execute</div>
        </div>
        <span class="text-slate-600">→</span>
        <div class="bg-yellow-500/10 border border-yellow-500/20 rounded px-3 py-1.5 text-center">
          <div class="font-medium text-yellow-400 text-xs">Binance</div>
          <div class="text-xs text-slate-500">Exchange</div>
        </div>
      </div>
    </div>
  </div>

  <script define:vars={{ supabaseUrl, supabaseAnonKey }}>
    // Fetch from Supabase (primary data source)
    async function fetchSupabase(table, options = {}) {
      const params = new URLSearchParams();
      if (options.select) params.set('select', options.select);
      if (options.order) params.set('order', options.order);
      if (options.limit) params.set('limit', options.limit);
      
      const url = `${supabaseUrl}/rest/v1/${table}?${params}`;
      try {
        const res = await fetch(url, {
          headers: {
            'apikey': supabaseAnonKey,
            'Authorization': `Bearer ${supabaseAnonKey}`
          }
        });
        return res.json();
      } catch (err) {
        console.warn(`Supabase fetch failed: ${table}`, err);
        return null;
      }
    }

    // Get bot status from Supabase
    async function getBotStatus() {
      const data = await fetchSupabase('burt_status', { limit: '1' });
      return data && data.length > 0 ? data[0] : null;
    }

    // Get recent trades from Supabase
    async function getTrades(limit = 10) {
      return fetchSupabase('burt_trades', { 
        select: '*',
        order: 'close_date.desc',
        limit: limit.toString()
      });
    }

    // Get daily performance from Supabase
    async function getDailyPerformance() {
      return fetchSupabase('burt_daily', {
        select: '*',
        order: 'date.desc',
        limit: '14'
      });
    }

    // Get signals from Supabase
    async function getSignals(limit = 10) {
      return fetchSupabase('burt_signals', {
        select: '*',
        order: 'created_at.desc',
        limit: limit.toString()
      });
    }

    function formatCurrency(val) {
      const num = parseFloat(val) || 0;
      const sign = num >= 0 ? '+' : '';
      return `${sign}$${Math.abs(num).toFixed(2)}`;
    }

    function formatPct(val) {
      const num = parseFloat(val) || 0;
      const sign = num >= 0 ? '+' : '';
      return `${sign}${num.toFixed(2)}%`;
    }

    function colorForValue(val) {
      const num = parseFloat(val) || 0;
      if (num > 0) return 'text-green-400';
      if (num < 0) return 'text-red-400';
      return 'text-slate-400';
    }

    function formatTime(date) {
      if (!date) return '--';
      const d = new Date(date);
      return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }

    async function updateHealth() {
      const status = await getBotStatus();
      const statusEl = document.getElementById('connection-status');
      
      if (!status) {
        statusEl.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-red-500"></span><span class="text-red-400">No Data</span>`;
        return;
      }
      
      // Check if data is fresh (within last hour)
      const lastUpdate = new Date(status.updated_at);
      const ageMinutes = (Date.now() - lastUpdate.getTime()) / 60000;
      const isFresh = ageMinutes < 60;
      
      statusEl.innerHTML = isFresh
        ? `<span class="w-1.5 h-1.5 rounded-full bg-green-500"></span><span class="text-green-400">Synced</span>`
        : `<span class="w-1.5 h-1.5 rounded-full bg-amber-500"></span><span class="text-amber-400">Stale (${Math.round(ageMinutes)}m)</span>`;
      
      // Services from system_status JSON
      let services = {};
      try {
        services = typeof status.system_status === 'string' 
          ? JSON.parse(status.system_status) 
          : status.system_status || {};
      } catch (e) {}
      
      const svcFreq = document.getElementById('svc-freqtrade');
      const svcOllama = document.getElementById('svc-ollama');
      const svcBridge = document.getElementById('svc-bridge');
      const svcRecon = document.getElementById('svc-reconciler');
      
      svcFreq.className = `w-2 h-2 rounded-full ${services.freqtrade ? 'bg-green-500' : 'bg-red-500'}`;
      svcOllama.className = `w-2 h-2 rounded-full ${services.ollama ? 'bg-green-500' : 'bg-red-500'}`;
      svcBridge.className = `w-2 h-2 rounded-full ${services.bridge ? 'bg-green-500' : 'bg-red-500'}`;
      svcRecon.className = 'w-2 h-2 rounded-full bg-slate-600';
      
      document.getElementById('svc-freqtrade-label').textContent = services.freqtrade ? 'running' : 'stopped';
      document.getElementById('svc-ollama-label').textContent = services.ollama ? 'ready' : 'offline';
      document.getElementById('svc-bridge-label').textContent = services.bridge ? 'v3.0' : 'offline';
      document.getElementById('svc-reconciler-label').textContent = 'n/a';
      
      // DLQ not available via Supabase
      document.getElementById('dlq-pending').textContent = '--';
      document.getElementById('dlq-failed').textContent = '--';
      
      // Last update
      document.getElementById('last-update').textContent = formatTime(lastUpdate);
    }

    async function updateSurvival() {
      const status = await getBotStatus();
      if (!status) return;
      
      const badge = document.getElementById('survival-badge');
      const survivalStatus = status.survival_status || 'UNKNOWN';
      
      const colors = {
        THRIVING: 'bg-green-500/10 text-green-400',
        SURVIVING: 'bg-amber-500/10 text-amber-400',
        DYING: 'bg-red-500/10 text-red-400',
        CRITICAL: 'bg-red-500/20 text-red-400'
      };
      
      badge.className = `px-2 py-0.5 rounded text-xs font-medium ${colors[survivalStatus] || 'bg-slate-700 text-slate-400'}`;
      badge.textContent = survivalStatus;
      
      // Update stats from status
      const pnl = parseFloat(status.total_pnl) || 0;
      const pnlEl = document.getElementById('total-pnl');
      pnlEl.textContent = formatCurrency(pnl);
      pnlEl.className = `text-xl font-semibold font-mono ${colorForValue(pnl)}`;
      
      const pctEl = document.getElementById('total-pnl-pct');
      const pct = parseFloat(status.total_pnl_pct) || 0;
      pctEl.textContent = formatPct(pct);
      pctEl.className = `text-xs font-mono mt-0.5 ${colorForValue(pct)}`;
      
      document.getElementById('win-rate').textContent = `${(parseFloat(status.win_rate) || 0).toFixed(1)}%`;
      document.getElementById('trade-count').textContent = `${status.total_trades || 0} trades`;
      
      // Fear & Greed
      document.getElementById('fear-greed').textContent = status.fear_greed || '--';
      document.getElementById('market-regime').textContent = status.market_regime || '--';
    }

    async function updatePositions() {
      const status = await getBotStatus();
      const container = document.getElementById('positions-container');
      const label = document.getElementById('position-label');
      
      // Parse open_positions from status
      let positions = [];
      try {
        positions = typeof status?.open_positions === 'string' 
          ? JSON.parse(status.open_positions) 
          : status?.open_positions || [];
      } catch (e) {}
      
      if (!positions || positions.length === 0) {
        container.innerHTML = '<div class="text-center py-6 text-slate-600 text-sm">No open positions</div>';
        label.textContent = '0 positions';
        document.getElementById('open-count').textContent = '0';
        document.getElementById('open-pnl').textContent = '$0 unrealized';
        return;
      }
      
      label.textContent = `${positions.length} position${positions.length !== 1 ? 's' : ''}`;
      document.getElementById('open-count').textContent = positions.length;
      
      let totalUnrealized = 0;
      
      container.innerHTML = `
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-slate-500 text-xs uppercase tracking-wide">
                <th class="text-left py-2 px-2">Pair</th>
                <th class="text-right py-2 px-2">Side</th>
                <th class="text-right py-2 px-2">P&L %</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-700/30">
              ${positions.map(p => {
                const pnlPct = parseFloat(p.profit_pct) || 0;
                return `
                  <tr class="hover:bg-slate-800/30">
                    <td class="py-2 px-2 font-medium text-slate-200 font-mono">${p.pair}</td>
                    <td class="py-2 px-2 text-right text-slate-400 uppercase">${p.side}</td>
                    <td class="py-2 px-2 text-right font-mono ${colorForValue(pnlPct)}">${formatPct(pnlPct)}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      const openPnlEl = document.getElementById('open-pnl');
      openPnlEl.textContent = `${positions.length} open`;
      openPnlEl.className = 'text-xs mt-0.5 text-slate-500';
    }

    async function updateSignals() {
      const signals = await getSignals(10);
      const container = document.getElementById('signals-container');
      
      if (!signals || signals.length === 0) {
        container.innerHTML = '<div class="p-4 text-center text-slate-600 text-sm">No recent signals</div>';
        return;
      }
      
      container.innerHTML = signals.map(s => `
        <div class="p-2 flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="w-1.5 h-1.5 rounded-full ${s.direction === 'long' ? 'bg-green-500' : 'bg-red-500'}"></span>
            <span class="font-mono text-sm text-slate-300">${s.pair}</span>
            <span class="text-xs text-slate-500 uppercase">${s.direction}</span>
          </div>
          <div class="text-right">
            <div class="text-xs text-slate-400">${(parseFloat(s.conviction) * 100).toFixed(0)}%</div>
            <div class="text-xs text-slate-600 font-mono">${formatTime(s.created_at)}</div>
          </div>
        </div>
      `).join('');
    }

    async function updateTrades() {
      const trades = await getTrades(10);
      const container = document.getElementById('trades-container');
      
      if (!trades || trades.length === 0) {
        container.innerHTML = '<div class="p-4 text-center text-slate-600 text-sm">No recent trades</div>';
        return;
      }
      
      let todayPnl = 0;
      let todayCount = 0;
      const today = new Date().toDateString();
      
      container.innerHTML = trades.map(t => {
        const pnl = parseFloat(t.profit_abs) || 0;
        const tradeDate = new Date(t.close_date || t.open_date).toDateString();
        if (tradeDate === today) {
          todayPnl += pnl;
          todayCount++;
        }
        
        return `
          <div class="p-2 flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="w-1.5 h-1.5 rounded-full ${pnl >= 0 ? 'bg-green-500' : 'bg-red-500'}"></span>
              <span class="font-mono text-sm text-slate-300">${t.pair}</span>
              <span class="text-xs text-slate-500 uppercase">${t.side}</span>
            </div>
            <div class="text-right">
              <div class="font-mono text-sm ${colorForValue(pnl)}">${formatCurrency(pnl)}</div>
              <div class="text-xs text-slate-600 font-mono">${formatTime(t.close_date)}</div>
            </div>
          </div>
        `;
      }).join('');
      
      const todayPnlEl = document.getElementById('today-pnl');
      todayPnlEl.textContent = formatCurrency(todayPnl);
      todayPnlEl.className = `text-xl font-semibold font-mono ${colorForValue(todayPnl)}`;
      document.getElementById('today-trades').textContent = `${todayCount} trades`;
    }

    async function updateDailyChart() {
      const daily = await getDailyPerformance();
      const container = document.getElementById('daily-chart');
      
      if (!daily || daily.length === 0) {
        container.innerHTML = '<div class="text-slate-600 text-sm">No daily data yet</div>';
        return;
      }
      
      const maxVal = Math.max(...daily.map(d => Math.abs(parseFloat(d.pnl) || 0)));
      const scale = maxVal > 0 ? 100 / maxVal : 1;
      
      container.innerHTML = daily.reverse().map(d => {
        const pnl = parseFloat(d.pnl) || 0;
        const height = Math.max(4, Math.abs(pnl) * scale);
        const color = pnl >= 0 ? 'bg-green-500/60' : 'bg-red-500/60';
        return `
          <div class="flex-1 flex flex-col items-center gap-1">
            <div class="w-full ${color} rounded-sm" style="height: ${height}px"></div>
            <span class="text-xs text-slate-600 font-mono">${d.date.slice(5)}</span>
          </div>
        `;
      }).join('');
    }

    async function updateAll() {
      await Promise.all([
        updateHealth(),
        updateSurvival(),
        updatePositions(),
        updateSignals(),
        updateTrades(),
        updateDailyChart()
      ]);
    }

    // Event listeners
    document.getElementById('refresh-btn').addEventListener('click', updateAll);
    
    // Pause toggle - requires direct bridge access (not available via Supabase)
    document.getElementById('pause-toggle').addEventListener('click', () => {
      alert('Pause control requires direct bridge access. Use A9 console.');
    });

    // DLQ process - requires direct bridge access
    document.getElementById('process-dlq').addEventListener('click', () => {
      alert('DLQ control requires direct bridge access. Use A9 console.');
    });

    // Initial load
    updateAll();
    
    // Auto-refresh every 30s
    setInterval(updateAll, 30000);
  </script>
</DashboardLayout>
