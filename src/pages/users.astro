---
import DashboardLayout from '../layouts/DashboardLayout.astro';
---

<DashboardLayout title="Users | Loop Command Center" active="users">
  <div class="p-6">
    <header class="mb-8">
      <h1 class="text-3xl font-bold">ðŸ‘¥ Users</h1>
      <p class="text-slate-400 mt-1">Growth metrics and user balances</p>
    </header>

    <div id="loading" class="text-center py-20">
      <div class="text-4xl mb-4 animate-pulse">ðŸ‘¥</div>
      <p class="text-slate-400">Loading users...</p>
    </div>

    <div id="content" class="hidden">
      <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
        <div class="bg-slate-800 rounded-xl p-5 border border-slate-700">
          <div class="text-slate-400 text-sm mb-1">Total Users</div>
          <div id="stat-total" class="text-3xl font-bold">0</div>
        </div>
        <div class="bg-slate-800 rounded-xl p-5 border border-slate-700">
          <div class="text-slate-400 text-sm mb-1">New Today</div>
          <div id="stat-today" class="text-3xl font-bold text-green-400">0</div>
        </div>
        <div class="bg-slate-800 rounded-xl p-5 border border-slate-700">
          <div class="text-slate-400 text-sm mb-1">This Week</div>
          <div id="stat-week" class="text-3xl font-bold text-blue-400">0</div>
        </div>
        <div class="bg-slate-800 rounded-xl p-5 border border-slate-700">
          <div class="text-slate-400 text-sm mb-1">This Month</div>
          <div id="stat-month" class="text-3xl font-bold text-purple-400">0</div>
        </div>
        <div class="bg-slate-800 rounded-xl p-5 border border-slate-700">
          <div class="text-slate-400 text-sm mb-1">Total Cred</div>
          <div id="stat-cred" class="text-3xl font-bold text-yellow-400">0</div>
        </div>
      </div>

      <div class="bg-slate-800 rounded-xl border border-slate-700">
        <div class="px-5 py-4 border-b border-slate-700">
          <h2 class="font-semibold">Recent Users</h2>
        </div>
        <div id="users-list" class="divide-y divide-slate-700">
          <div class="p-5 text-slate-500">No users yet</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://ibhjsutgxhujbjhrilwx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImliaGpzdXRneGh1amJqaHJpbHd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzNzkzODgsImV4cCI6MjA4NDk1NTM4OH0.5BWyde9ozVjf9KV-se6o0g6zf2MBWlUWU6pN98KaOO4';

    function fmt(n: number) {
      return n >= 1000000 ? (n/1000000).toFixed(1) + 'M' : n >= 1000 ? (n/1000).toFixed(1) + 'K' : n.toString();
    }

    function timeAgo(date: string) {
      const diff = Date.now() - new Date(date).getTime();
      const mins = Math.floor(diff / 60000);
      if (mins < 60) return mins + 'm ago';
      const hrs = Math.floor(mins / 60);
      if (hrs < 24) return hrs + 'h ago';
      return Math.floor(hrs / 24) + 'd ago';
    }

    async function load() {
      try {
        const res = await fetch(`${SUPABASE_URL}/functions/v1/users-status`, {
          headers: { 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` },
        });
        const data = await res.json();

        document.getElementById('stat-total')!.textContent = fmt(data.totals.total);
        document.getElementById('stat-today')!.textContent = data.totals.newToday;
        document.getElementById('stat-week')!.textContent = data.totals.newWeek;
        document.getElementById('stat-month')!.textContent = data.totals.newMonth;
        document.getElementById('stat-cred')!.textContent = fmt(data.totals.totalCred);

        const list = document.getElementById('users-list')!;
        if (data.users.length === 0) {
          list.innerHTML = '<div class="p-5 text-slate-500">No users registered yet.</div>';
        } else {
          list.innerHTML = data.users.map((u: any) => `
            <div class="p-5 flex items-center justify-between">
              <div>
                <div class="font-medium">${u.phone || u.email || u.id.slice(0,8)}</div>
                <div class="text-sm text-slate-400">${u.loops.length > 0 ? u.loops.join(', ') : 'No loops'}</div>
              </div>
              <div class="text-right">
                <div class="font-medium text-yellow-400">${fmt(u.totalCred)} Cred</div>
                <div class="text-xs text-slate-500">${timeAgo(u.created_at)}</div>
              </div>
            </div>
          `).join('');
        }

        document.getElementById('loading')!.classList.add('hidden');
        document.getElementById('content')!.classList.remove('hidden');
      } catch (e) {
        console.error(e);
        document.getElementById('loading')!.innerHTML = '<div class="text-red-400">Failed to load</div>';
      }
    }

    load();
  </script>
</DashboardLayout>
