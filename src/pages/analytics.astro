---
import DashboardLayout from '../layouts/DashboardLayout.astro';
---

<DashboardLayout title="Analytics | Loop Command Center" active="analytics">
  <div class="p-6">
    <header class="mb-8 flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold">Analytics</h1>
        <p class="text-slate-400 mt-1">Real-time metrics and insights</p>
      </div>
      <div class="flex items-center gap-3">
        <span id="last-update" class="text-sm text-slate-500"></span>
        <button id="refresh-btn" onclick="load()" class="bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded text-sm transition flex items-center gap-1">
          Refresh
        </button>
      </div>
    </header>

    <div id="loading" class="text-center py-20">
      <!-- Loading -->
      <p class="text-slate-400">Loading analytics...</p>
    </div>

    <div id="content" class="hidden">
      <!-- Summary Cards -->
      <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-8">
        <div class="bg-slate-800 rounded-xl p-5 border border-slate-700">
          <div class="text-slate-400 text-sm mb-1">Total Users</div>
          <div id="stat-users" class="text-2xl font-bold">0</div>
        </div>
        <div class="bg-slate-800 rounded-xl p-5 border border-slate-700">
          <div class="text-slate-400 text-sm mb-1">Total Merchants</div>
          <div id="stat-merchants" class="text-2xl font-bold">0</div>
        </div>
        <div class="bg-slate-800 rounded-xl p-5 border border-slate-700">
          <div class="text-slate-400 text-sm mb-1">Active Merchants</div>
          <div id="stat-active" class="text-2xl font-bold text-green-400">0</div>
        </div>
        <div class="bg-slate-800 rounded-xl p-5 border border-slate-700">
          <div class="text-slate-400 text-sm mb-1">30d Revenue</div>
          <div id="stat-revenue" class="text-2xl font-bold text-yellow-400">$0</div>
        </div>
        <div class="bg-slate-800 rounded-xl p-5 border border-slate-700">
          <div class="text-slate-400 text-sm mb-1">Total Revenue</div>
          <div id="stat-total-revenue" class="text-2xl font-bold">$0</div>
        </div>
        <div class="bg-slate-800 rounded-xl p-5 border border-slate-700">
          <div class="text-slate-400 text-sm mb-1">Retention Rate</div>
          <div id="stat-retention" class="text-2xl font-bold text-blue-400">0%</div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- User Acquisition -->
        <div class="bg-slate-800 rounded-xl border border-slate-700">
          <div class="px-5 py-4 border-b border-slate-700">
            <h2 class="font-semibold"> User Acquisition (30 days)</h2>
          </div>
          <div class="p-5">
            <div id="chart-acquisition" class="h-48 flex items-end gap-1"></div>
            <div id="acquisition-empty" class="hidden text-center py-8 text-slate-500">No user signups yet</div>
          </div>
        </div>

        <!-- Revenue Over Time -->
        <div class="bg-slate-800 rounded-xl border border-slate-700">
          <div class="px-5 py-4 border-b border-slate-700">
            <h2 class="font-semibold"> Revenue (30 days)</h2>
          </div>
          <div class="p-5">
            <div id="chart-revenue" class="h-48 flex items-end gap-1"></div>
            <div id="revenue-empty" class="hidden text-center py-8 text-slate-500">No transactions yet</div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Revenue by Type -->
        <div class="bg-slate-800 rounded-xl border border-slate-700">
          <div class="px-5 py-4 border-b border-slate-700">
            <h2 class="font-semibold"> Revenue Breakdown</h2>
          </div>
          <div id="revenue-breakdown" class="p-5">
            <div class="text-center py-8 text-slate-500">No revenue data yet</div>
          </div>
        </div>

        <!-- Geographic Distribution -->
        <div class="bg-slate-800 rounded-xl border border-slate-700">
          <div class="px-5 py-4 border-b border-slate-700">
            <h2 class="font-semibold">üó∫Ô∏è Geographic Distribution</h2>
          </div>
          <div id="geo-distribution" class="p-5">
            <div class="text-center py-8 text-slate-500">No merchant locations yet</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://ibhjsutgxhujbjhrilwx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImliaGpzdXRneGh1amJqaHJpbHd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzNzkzODgsImV4cCI6MjA4NDk1NTM4OH0.5BWyde9ozVjf9KV-se6o0g6zf2MBWlUWU6pN98KaOO4';

    function fmt(n: number) {
      return n >= 1000000 ? '$' + (n/1000000).toFixed(1) + 'M' : n >= 1000 ? '$' + (n/1000).toFixed(1) + 'K' : '$' + n;
    }

    function renderBarChart(containerId: string, emptyId: string, data: {value: number}[], color: string) {
      const container = document.getElementById(containerId)!;
      const empty = document.getElementById(emptyId)!;
      const maxVal = Math.max(...data.map(d => d.value), 1);
      const hasData = data.some(d => d.value > 0);
      
      if (!hasData) {
        container.classList.add('hidden');
        empty.classList.remove('hidden');
        return;
      }
      
      container.classList.remove('hidden');
      empty.classList.add('hidden');
      container.innerHTML = data.map(d => {
        const height = Math.max((d.value / maxVal) * 100, 2);
        return `<div class="flex-1 ${color} rounded-t opacity-80 hover:opacity-100 transition-opacity" style="height: ${height}%" title="${d.value}"></div>`;
      }).join('');
    }

    async function load() {
      document.getElementById('loading')!.classList.remove('hidden');
      document.getElementById('content')!.classList.add('hidden');
      
      try {
        const res = await fetch(`${SUPABASE_URL}/functions/v1/analytics-status`, {
          headers: { 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` },
        });
        const data = await res.json();

        document.getElementById('stat-users')!.textContent = data.summary.totalUsers;
        document.getElementById('stat-merchants')!.textContent = data.summary.totalMerchants;
        document.getElementById('stat-active')!.textContent = data.summary.activeMerchants;
        document.getElementById('stat-revenue')!.textContent = fmt(data.summary.revenue30d);
        document.getElementById('stat-total-revenue')!.textContent = fmt(data.summary.totalRevenue);
        document.getElementById('stat-retention')!.textContent = data.summary.retentionRate + '%';

        renderBarChart('chart-acquisition', 'acquisition-empty', data.acquisition.map((d: any) => ({ value: d.users })), 'bg-blue-500');
        renderBarChart('chart-revenue', 'revenue-empty', data.revenue.map((d: any) => ({ value: d.revenue })), 'bg-green-500');

        const breakdown = document.getElementById('revenue-breakdown')!;
        if (data.revenueByType.length === 0) {
          breakdown.innerHTML = '<div class="text-center py-8 text-slate-500">No revenue data yet</div>';
        } else {
          const total = data.revenueByType.reduce((s: number, r: any) => s + r.amount, 0);
          breakdown.innerHTML = data.revenueByType.map((r: any) => {
            const pct = total > 0 ? Math.round((r.amount / total) * 100) : 0;
            return `<div class="flex items-center justify-between py-2 border-b border-slate-700 last:border-0"><span class="capitalize">${r.type}</span><div class="flex items-center gap-3"><div class="w-24 h-2 bg-slate-700 rounded-full overflow-hidden"><div class="h-full bg-yellow-500" style="width: ${pct}%"></div></div><span class="font-medium w-20 text-right">${fmt(r.amount)}</span></div></div>`;
          }).join('');
        }

        const geo = document.getElementById('geo-distribution')!;
        if (data.geographic.length === 0) {
          geo.innerHTML = '<div class="text-center py-8 text-slate-500">No merchant locations yet</div>';
        } else {
          geo.innerHTML = data.geographic.slice(0, 10).map((g: any) => `<div class="flex items-center justify-between py-2 border-b border-slate-700 last:border-0"><span>üìç ${g.location}</span><span class="font-medium">${g.merchants} merchant${g.merchants !== 1 ? 's' : ''}</span></div>`).join('');
        }

        document.getElementById('last-update')!.textContent = 'Updated ' + new Date().toLocaleTimeString();
        document.getElementById('loading')!.classList.add('hidden');
        document.getElementById('content')!.classList.remove('hidden');
      } catch (e) {
        console.error(e);
        document.getElementById('loading')!.innerHTML = `
          <!-- Error -->
          <p class="text-red-400 mb-4">Failed to load analytics</p>
          <button onclick="load()" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded">Retry</button>
        `;
      }
    }

    load();
  </script>
</DashboardLayout>
