---
import DashboardLayout from '../layouts/DashboardLayout.astro';
import StatusDot from '../components/ui/StatusDot.astro';
import Badge from '../components/ui/Badge.astro';
import StatCard from '../components/ui/StatCard.astro';
import projects from '../data/projects.json';
import activity from '../data/activity.json';
import planned from '../data/planned.json';
import schedule from '../data/schedule.json';
import aaInsights from '../data/aa-insights.json';
import specs from '../data/specs.json';
import decisions from '../data/decisions.json';
import checklist from '../data/checklist.json';

// Calculate days until dates
function getDaysUntil(dateStr: string): number {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const target = new Date(dateStr);
  const diff = target.getTime() - today.getTime();
  return Math.ceil(diff / (1000 * 60 * 60 * 24));
}

function getStatusVariant(status: string): 'success' | 'warning' | 'error' | 'info' | 'progress' | 'neutral' {
  switch (status) {
    case 'active':
    case 'live':
    case 'done':
      return 'success';
    case 'in-progress':
    case 'planned':
      return 'warning';
    case 'blocked':
      return 'error';
    default:
      return 'neutral';
  }
}

function getPriorityVariant(priority: string): 'success' | 'warning' | 'error' | 'info' | 'progress' | 'neutral' {
  switch (priority) {
    case 'critical': return 'error';
    case 'high': return 'warning';
    case 'medium': return 'info';
    default: return 'neutral';
  }
}

// Calculate stats from projects
const totalProjects = projects.length;
const activeProjects = projects.filter(p => p.status === 'live' || p.status === 'active').length;
const totalTasks = projects.reduce((sum, p) => {
  const t = p.tasks || {todo: [], inProgress: [], done: []};
  return sum + (t.todo?.length || 0) + (t.inProgress?.length || 0) + (t.done?.length || 0);
}, 0);
const completedTasks = projects.reduce((sum, p) => sum + (p.tasks?.done?.length || 0), 0);
const inProgressTasks = projects.reduce((sum, p) => sum + (p.tasks?.inProgress?.length || 0), 0);
const daysUntilBidOpens = getDaysUntil(aaInsights.bidCycle.nextBidOpens);
const daysUntilBidCloses = getDaysUntil(aaInsights.bidCycle.nextBidCloses);

// Helper functions
function isUrgent(days: number): boolean {
  return days >= 0 && days <= 5;
}
function isSoon(days: number): boolean {
  return days >= 0 && days <= 3;
}
function isExpired(days: number): boolean {
  return days <= 0;
}

// Find next trip
const today = new Date();
today.setHours(0, 0, 0, 0);
const nextTrip = schedule.trips.find(t => new Date(t.days[0]) >= today) || schedule.trips[0];
const daysUntilNextTrip = nextTrip ? getDaysUntil(nextTrip.days[0]) : 0;

// Pre-compute trip status for each trip
interface TripWithStatus {
  sequence: string;
  dates: string;
  days: string[];
  route: string;
  credit: string;
  details: { date: string; dep: string; arr: string }[];
  isUpcoming: boolean;
  isCurrent: boolean;
}

const tripsWithStatus: TripWithStatus[] = schedule.trips.map(trip => {
  const tripStart = new Date(trip.days[0]);
  const tripEnd = new Date(trip.days[trip.days.length - 1]);
  return {
    ...trip,
    isUpcoming: tripStart >= today,
    isCurrent: tripStart <= today && tripEnd >= today
  };
});

// Get recent activity (last 5)
const recentActivity = activity.slice(0, 5);

// Aggregate tasks from all projects
const allTodo = projects.flatMap(p => (p.tasks?.todo || []).map(t => ({...t, project: p.name})));
const allInProgress = projects.flatMap(p => (p.tasks?.inProgress || []).map(t => ({...t, project: p.name})));
const allDone = projects.flatMap(p => (p.tasks?.done || []).map(t => typeof t === 'string' ? {title: t, project: p.name} : {...t, project: p.name}));

// Get next 3 todos (for Overview)
const nextTodos = allTodo.slice(0, 3);

// Calculate work window status
interface WorkWindowWithStatus {
  start: string;
  end: string;
  label: string;
  highlight: string;
  daysRemaining: number;
  totalDays: number;
  status: 'past' | 'current' | 'upcoming';
  dateRange: string;
}

const workWindowsWithStatus: WorkWindowWithStatus[] = schedule.loopWorkWindows.map(window => {
  const startDate = new Date(window.start);
  const endDate = new Date(window.end);
  endDate.setHours(23, 59, 59);
  
  const totalDays = Math.ceil((endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24)) + 1;
  const daysUntilStart = getDaysUntil(window.start);
  const daysUntilEnd = Math.ceil((endDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
  
  let status: 'past' | 'current' | 'upcoming';
  let daysRemaining: number;
  
  if (daysUntilEnd < 0) {
    status = 'past';
    daysRemaining = 0;
  } else if (daysUntilStart <= 0) {
    status = 'current';
    daysRemaining = daysUntilEnd + 1;
  } else {
    status = 'upcoming';
    daysRemaining = totalDays;
  }
  
  const startMonth = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  const endMonth = endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  const dateRange = startMonth === endMonth ? startMonth : `${startMonth} - ${endMonth}`;
  
  return {
    ...window,
    daysRemaining,
    totalDays,
    status,
    dateRange
  };
});

const nextWorkWindow = workWindowsWithStatus.find(w => w.status === 'current') || 
                       workWindowsWithStatus.find(w => w.status === 'upcoming') ||
                       workWindowsWithStatus[0];
---

<DashboardLayout title="Command Center | Loop" active="dashboard">
  <div class="min-h-screen bg-[#0f1419]">
    <!-- KPI Header Strip -->
    <header class="hidden md:block bg-[#1a2028] border-b border-slate-700/50 sticky top-0 z-30">
      <div class="max-w-7xl mx-auto px-6 py-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <StatusDot status="success" pulse />
            <h1 class="text-lg font-semibold text-slate-100">Command Center</h1>
          </div>
          <div class="flex items-center gap-6 text-sm">
            <div class="flex items-center gap-2">
              <span class="text-slate-500 text-xs uppercase tracking-wide">Projects</span>
              <span class="font-mono font-semibold text-slate-200">{totalProjects}</span>
            </div>
            <div class="w-px h-4 bg-slate-700"></div>
            <div class="flex items-center gap-2">
              <span class="text-slate-500 text-xs uppercase tracking-wide">Tasks</span>
              <span class="font-mono font-semibold text-green-400">{completedTasks}</span>
              <span class="text-slate-600">/</span>
              <span class="font-mono text-slate-400">{totalTasks}</span>
            </div>
            <div class="w-px h-4 bg-slate-700"></div>
            <div class="flex items-center gap-2">
              <span class="text-slate-500 text-xs uppercase tracking-wide">Next Trip</span>
              <span class:list={['font-mono font-semibold', isSoon(daysUntilNextTrip) ? 'text-amber-400' : 'text-slate-200']}>
                {isExpired(daysUntilNextTrip) ? 'TODAY' : `${daysUntilNextTrip}d`}
              </span>
            </div>
            <div class="w-px h-4 bg-slate-700"></div>
            <div class="flex items-center gap-2">
              <span class="text-slate-500 text-xs uppercase tracking-wide">Bid</span>
              <span class:list={['font-mono font-semibold', isUrgent(daysUntilBidOpens) ? 'text-amber-400' : 'text-slate-200']}>
                {isExpired(daysUntilBidOpens) ? 'OPEN' : `${daysUntilBidOpens}d`}
              </span>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 py-6 sm:px-6">
      <!-- Tab Navigation -->
      <nav class="mb-6">
        <!-- Desktop Tabs -->
        <div class="hidden sm:flex bg-[#1a2028] border border-slate-700/50 rounded-lg p-1 gap-1" id="desktop-tabs">
          <button data-tab="overview" class="tab-btn active px-4 py-2 rounded text-sm font-medium transition-all">Overview</button>
          <button data-tab="planned" class="tab-btn px-4 py-2 rounded text-sm font-medium transition-all">Planned</button>
          <button data-tab="projects" class="tab-btn px-4 py-2 rounded text-sm font-medium transition-all">Projects</button>
          <button data-tab="specs" class="tab-btn px-4 py-2 rounded text-sm font-medium transition-all">Specs</button>
          <button data-tab="decisions" class="tab-btn px-4 py-2 rounded text-sm font-medium transition-all">Decisions</button>
          <button data-tab="tasks" class="tab-btn px-4 py-2 rounded text-sm font-medium transition-all">Tasks</button>
          <button data-tab="schedule" class="tab-btn px-4 py-2 rounded text-sm font-medium transition-all">Schedule</button>
          <button data-tab="aa-insights" class="tab-btn px-4 py-2 rounded text-sm font-medium transition-all">AA Insights</button>
          <button data-tab="activity" class="tab-btn px-4 py-2 rounded text-sm font-medium transition-all">Activity</button>
        </div>
        
        <!-- Mobile Dropdown -->
        <div class="sm:hidden">
          <select id="mobile-tab-select" class="w-full bg-[#1a2028] border border-slate-700/50 rounded-lg px-4 py-3 text-slate-200 text-sm font-medium focus:outline-none focus:ring-1 focus:ring-emerald-500/50">
            <option value="overview">Overview</option>
            <option value="planned">Planned</option>
            <option value="projects">Projects</option>
            <option value="specs">Specs</option>
            <option value="decisions">Decisions</option>
            <option value="tasks">Tasks</option>
            <option value="schedule">Schedule</option>
            <option value="aa-insights">AA Insights</option>
            <option value="activity">Activity</option>
          </select>
        </div>
      </nav>

      <!-- Tab Content -->
      <div class="tab-content">
        <!-- Overview Tab -->
        <section id="tab-overview" class="tab-panel">
          <!-- Quick Stats Grid -->
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg p-4">
              <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">Projects</div>
              <div class="text-2xl font-semibold font-mono text-slate-100">{totalProjects}</div>
              <div class="text-xs text-green-400 mt-1">{activeProjects} active</div>
            </div>
            <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg p-4">
              <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">Tasks Complete</div>
              <div class="text-2xl font-semibold font-mono text-green-400">{completedTasks}</div>
              <div class="text-xs text-slate-500 mt-1">of {totalTasks} total</div>
            </div>
            <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg p-4">
              <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">Next Trip</div>
              <div class:list={['text-2xl font-semibold font-mono', isSoon(daysUntilNextTrip) ? 'text-amber-400' : 'text-slate-100']}>
                {isExpired(daysUntilNextTrip) ? 'Today' : `${daysUntilNextTrip}d`}
              </div>
              <div class="text-xs text-slate-500 mt-1 truncate">{nextTrip?.route || 'None scheduled'}</div>
            </div>
            <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg p-4">
              <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">Bid Cycle</div>
              <div class:list={['text-2xl font-semibold font-mono', isUrgent(daysUntilBidOpens) ? 'text-amber-400' : 'text-slate-100']}>
                {isExpired(daysUntilBidOpens) ? 'Open' : `${daysUntilBidOpens}d`}
              </div>
              <div class="text-xs text-slate-500 mt-1">until bid opens</div>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Next Actions -->
            <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg p-5">
              <h3 class="text-sm font-semibold text-slate-200 uppercase tracking-wide mb-4">Next Actions</h3>
              <ul class="space-y-3">
                {nextTodos.map((todo, i) => (
                  <li class="flex items-start gap-3 bg-slate-800/50 rounded-lg p-3">
                    <span class:list={[
                      'font-mono font-bold text-sm',
                      todo.priority === 'critical' ? 'text-red-400' : 
                      todo.priority === 'high' ? 'text-amber-400' : 'text-slate-400'
                    ]}>{i + 1}</span>
                    <div class="flex-1">
                      <span class="text-slate-300 text-sm">{typeof todo === 'string' ? todo : todo.title}</span>
                      {todo.category && <span class="ml-2 text-xs text-slate-500">({todo.category})</span>}
                    </div>
                  </li>
                ))}
                {nextTodos.length === 0 && (
                  <li class="text-slate-500 text-sm">No pending actions</li>
                )}
              </ul>
            </div>

            <!-- Upcoming -->
            <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg p-5">
              <h3 class="text-sm font-semibold text-slate-200 uppercase tracking-wide mb-4">Upcoming</h3>
              <div class="space-y-3">
                {nextTrip && (
                  <div class="bg-blue-500/5 border border-blue-500/20 rounded-lg p-3">
                    <div class="flex items-center justify-between mb-1">
                      <div class="flex items-center gap-2">
                        <StatusDot status="info" size="sm" />
                        <span class="text-blue-400 text-xs font-medium uppercase tracking-wide">Flight</span>
                      </div>
                      <span class="text-xs text-slate-500 font-mono">{nextTrip.dates}</span>
                    </div>
                    <p class="text-slate-200 font-medium text-sm">{nextTrip.route}</p>
                    <p class="text-slate-500 text-xs mt-1">Credit: {nextTrip.credit}</p>
                  </div>
                )}
                {nextWorkWindow && (
                  <div class:list={[
                    'rounded-lg p-3 border',
                    nextWorkWindow.status === 'current' 
                      ? 'bg-emerald-500/5 border-emerald-500/20' 
                      : nextWorkWindow.highlight === 'big'
                        ? 'bg-amber-500/5 border-amber-500/20'
                        : 'bg-slate-800/50 border-slate-700/50'
                  ]}>
                    <div class="flex items-center justify-between mb-1">
                      <div class="flex items-center gap-2">
                        <StatusDot status={nextWorkWindow.status === 'current' ? 'success' : 'neutral'} size="sm" />
                        <span class:list={[
                          'text-xs font-medium uppercase tracking-wide',
                          nextWorkWindow.status === 'current' ? 'text-emerald-400' :
                          nextWorkWindow.highlight === 'big' ? 'text-amber-400' : 'text-slate-400'
                        ]}>Work Window</span>
                      </div>
                      <span class="text-xs text-slate-500 font-mono">{nextWorkWindow.dateRange}</span>
                    </div>
                    <p class:list={[
                      'text-sm',
                      nextWorkWindow.status === 'current' ? 'text-emerald-300/70' : 'text-slate-400'
                    ]}>
                      {nextWorkWindow.label} · 
                      {nextWorkWindow.status === 'current' 
                        ? ` ${nextWorkWindow.daysRemaining}d remaining`
                        : ` ${nextWorkWindow.totalDays} days`}
                    </p>
                  </div>
                )}
              </div>
            </div>

            <!-- Recent Activity -->
            <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg p-5 lg:col-span-2">
              <h3 class="text-sm font-semibold text-slate-200 uppercase tracking-wide mb-4">Recent Activity</h3>
              <div class="space-y-1">
                {recentActivity.map((item) => (
                  <div class="flex items-center gap-4 py-2 border-b border-slate-700/30 last:border-0">
                    <span class="text-slate-600 text-xs font-mono w-20 shrink-0">{item.date}</span>
                    <span class="text-slate-400 text-sm">{item.action}</span>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </section>

        <!-- Planned Tab -->
        <section id="tab-planned" class="tab-panel hidden">
          <!-- Vision Banner -->
          <div class="bg-gradient-to-r from-emerald-500/10 to-cyan-500/10 border border-emerald-500/20 rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-slate-100 mb-2">Loop Vision</h2>
            <p class="text-emerald-300/80 text-lg">"{planned.vision}"</p>
            <p class="text-slate-500 text-xs mt-3 font-mono">Updated: {planned.lastUpdated}</p>
          </div>

          <!-- Feature Categories -->
          <div class="space-y-6">
            {planned.categories.map((category) => (
              <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg overflow-hidden">
                <div class="p-5 border-b border-slate-700/50">
                  <div class="flex items-start justify-between">
                    <div>
                      <h3 class="text-lg font-semibold text-slate-100">{category.name}</h3>
                      <p class="text-slate-400 text-sm mt-1">{category.description}</p>
                    </div>
                    <Badge variant={
                      category.status === 'core-vision' ? 'success' :
                      category.status === 'planned' ? 'warning' :
                      category.status === 'researching' ? 'info' : 'neutral'
                    }>{category.status}</Badge>
                  </div>
                </div>
                <div class="p-5">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {category.features.map((feature) => (
                      <div class:list={[
                        'rounded-lg p-4 border',
                        feature.priority === 'critical' ? 'bg-red-500/5 border-red-500/20' :
                        feature.priority === 'high' ? 'bg-amber-500/5 border-amber-500/20' :
                        feature.priority === 'medium' ? 'bg-blue-500/5 border-blue-500/20' :
                        'bg-slate-800/50 border-slate-700/50'
                      ]}>
                        <div class="flex items-start justify-between mb-2">
                          <h4 class="font-medium text-slate-200 text-sm">{feature.title}</h4>
                          <Badge variant={getPriorityVariant(feature.priority)} size="sm">{feature.priority}</Badge>
                        </div>
                        <p class="text-slate-400 text-sm mb-2">{feature.description}</p>
                        <p class="text-cyan-400/80 text-xs">Impact: {feature.impact}</p>
                        {feature.note && (
                          <p class="text-slate-500 text-xs mt-2">Note: {feature.note}</p>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            ))}
          </div>
        </section>

        <!-- Projects Tab -->
        <section id="tab-projects" class="tab-panel hidden">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            {projects.map((project) => (
              <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg overflow-hidden hover:border-slate-600/50 transition-colors">
                <div class="p-5">
                  <div class="flex items-start justify-between mb-3">
                    <div>
                      <h3 class="text-base font-semibold text-slate-100">{project.name}</h3>
                      <p class="text-slate-500 text-xs mt-0.5 font-mono">{project.stack}</p>
                    </div>
                    <Badge variant={getStatusVariant(project.status)}>{project.status}</Badge>
                  </div>
                  <p class="text-slate-400 text-sm mb-4">{project.description}</p>
                  
                  <!-- Task Counts - Clean, no emoji -->
                  <div class="flex gap-4 mb-4 text-xs">
                    <div class="flex items-center gap-1.5">
                      <StatusDot status="error" size="sm" />
                      <span class="text-slate-400">{project.tasks?.todo?.length || 0} todo</span>
                    </div>
                    <div class="flex items-center gap-1.5">
                      <StatusDot status="warning" size="sm" pulse />
                      <span class="text-slate-400">{project.tasks?.inProgress?.length || 0} active</span>
                    </div>
                    <div class="flex items-center gap-1.5">
                      <StatusDot status="success" size="sm" />
                      <span class="text-slate-400">{project.tasks?.done?.length || 0} done</span>
                    </div>
                  </div>

                  <!-- Collapsible Sections -->
                  {project.tasks?.todo?.length > 0 && (
                    <details class="group mb-2">
                      <summary class="cursor-pointer text-sm text-slate-400 hover:text-slate-300 transition-colors flex items-center gap-2 py-1">
                        <span class="transform transition-transform group-open:rotate-90 text-xs">▸</span>
                        To Do ({project.tasks.todo.length})
                      </summary>
                      <ul class="mt-2 space-y-1 pl-4 border-l border-slate-700/50">
                        {project.tasks.todo.map((task) => (
                          <li class="text-slate-400 text-sm py-1 flex items-start gap-2">
                            <StatusDot status={getPriorityVariant(task.priority || 'low')} size="sm" />
                            <div>
                              <span>{typeof task === 'string' ? task : task.title}</span>
                              {task.note && <span class="text-slate-600 text-xs block">{task.note}</span>}
                            </div>
                          </li>
                        ))}
                      </ul>
                    </details>
                  )}

                  {project.tasks?.inProgress?.length > 0 && (
                    <details class="group mb-2" open>
                      <summary class="cursor-pointer text-sm text-amber-400/80 hover:text-amber-400 transition-colors flex items-center gap-2 py-1">
                        <span class="transform transition-transform group-open:rotate-90 text-xs">▸</span>
                        In Progress ({project.tasks.inProgress.length})
                      </summary>
                      <ul class="mt-2 space-y-1 pl-4 border-l border-amber-500/20">
                        {project.tasks.inProgress.map((task) => (
                          <li class="text-slate-300 text-sm py-1 flex items-start gap-2">
                            <StatusDot status="warning" size="sm" pulse />
                            <span>{typeof task === 'string' ? task : task.title}</span>
                          </li>
                        ))}
                      </ul>
                    </details>
                  )}

                  {project.tasks?.done?.length > 0 && (
                    <details class="group">
                      <summary class="cursor-pointer text-sm text-slate-500 hover:text-slate-400 transition-colors flex items-center gap-2 py-1">
                        <span class="transform transition-transform group-open:rotate-90 text-xs">▸</span>
                        Completed ({project.tasks.done.length})
                      </summary>
                      <ul class="mt-2 space-y-1 pl-4 border-l border-slate-700/30 max-h-32 overflow-y-auto">
                        {project.tasks.done.slice(0, 10).map((task) => (
                          <li class="text-slate-600 text-sm py-0.5">
                            {typeof task === 'string' ? task : task.title}
                          </li>
                        ))}
                        {project.tasks.done.length > 10 && (
                          <li class="text-slate-700 text-xs">+{project.tasks.done.length - 10} more</li>
                        )}
                      </ul>
                    </details>
                  )}
                </div>
              </div>
            ))}
          </div>
        </section>

        <!-- Specs Tab -->
        <section id="tab-specs" class="tab-panel hidden">
          <div class="bg-amber-500/5 border border-amber-500/20 rounded-lg p-4 mb-6">
            <h3 class="text-amber-400 font-medium text-sm uppercase tracking-wide mb-2">Pre-Build Checklist</h3>
            <p class="text-slate-400 text-sm mb-3">Run through before starting any major feature:</p>
            <ul class="grid grid-cols-1 md:grid-cols-2 gap-2">
              {checklist.preBuild.items.map((item) => (
                <li class="flex items-start gap-2 text-sm">
                  <span class="text-slate-600 mt-0.5">—</span>
                  <div>
                    <span class="text-slate-300">{item.question}</span>
                    {item.note && <span class="text-slate-600 text-xs block">{item.note}</span>}
                  </div>
                </li>
              ))}
            </ul>
          </div>

          <h2 class="text-lg font-semibold text-slate-100 mb-4">Specifications</h2>
          <div class="space-y-4">
            {specs.map((spec) => (
              <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg overflow-hidden">
                <div class="p-5 border-b border-slate-700/50">
                  <div class="flex items-start justify-between mb-2">
                    <div>
                      <h3 class="text-base font-semibold text-slate-100">{spec.title}</h3>
                      <p class="text-slate-500 text-sm">{spec.project}</p>
                    </div>
                    <Badge variant={spec.status === 'approved' ? 'success' : 'warning'}>{spec.status}</Badge>
                  </div>
                  <div class="flex gap-4 text-xs text-slate-500 font-mono mt-2">
                    <span>Created: {spec.createdAt}</span>
                    {spec.approvedAt && <span>Approved: {spec.approvedAt}</span>}
                  </div>
                </div>

                <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <h4 class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-2">Target</h4>
                    <ul class="space-y-1.5 text-sm">
                      <li class="flex justify-between">
                        <span class="text-slate-500">Platforms:</span>
                        <span class="text-slate-300">{spec.target.platforms.join(', ')}</span>
                      </li>
                      <li class="flex justify-between">
                        <span class="text-slate-500">Distribution:</span>
                        <span class="text-slate-300">{spec.target.distribution}</span>
                      </li>
                      <li class="flex justify-between">
                        <span class="text-slate-500">Min OS:</span>
                        <span class="text-slate-300">{spec.target.minOS}</span>
                      </li>
                    </ul>
                  </div>

                  <div>
                    <h4 class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-2">Stack</h4>
                    <ul class="space-y-1.5 text-sm">
                      {Object.entries(spec.stack).map(([key, value]) => (
                        <li class="flex justify-between">
                          <span class="text-slate-500 capitalize">{key}:</span>
                          <span class="text-slate-300 text-right font-mono text-xs">{value}</span>
                        </li>
                      ))}
                    </ul>
                  </div>
                </div>

                <div class="p-5 border-t border-slate-700/50">
                  <h4 class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-2">Requirements</h4>
                  <ul class="grid grid-cols-1 md:grid-cols-2 gap-1.5">
                    {spec.requirements.map((req) => (
                      <li class="flex items-start gap-2 text-sm">
                        <StatusDot status="success" size="sm" />
                        <span class="text-slate-300">{req}</span>
                      </li>
                    ))}
                  </ul>
                </div>

                {spec.outOfScope && spec.outOfScope.length > 0 && (
                  <div class="p-5 border-t border-slate-700/50 bg-slate-800/30">
                    <h4 class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-2">Out of Scope</h4>
                    <div class="flex flex-wrap gap-2">
                      {spec.outOfScope.map((item) => (
                        <span class="px-2 py-0.5 bg-red-500/10 border border-red-500/20 rounded text-red-400/80 text-xs">
                          {item}
                        </span>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            ))}
          </div>
        </section>

        <!-- Decisions Tab -->
        <section id="tab-decisions" class="tab-panel hidden">
          <p class="text-slate-400 text-sm mb-4">Architectural decisions and rationale. Reference before making changes.</p>
          <div class="space-y-3">
            {decisions.map((dec) => (
              <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg overflow-hidden">
                <div class="p-4 flex items-start gap-4">
                  <Badge variant={
                    dec.category === 'platform' ? 'progress' :
                    dec.category === 'auth' ? 'success' :
                    dec.category === 'email' ? 'info' :
                    dec.category === 'backend' ? 'warning' :
                    'neutral'
                  } size="sm">{dec.category}</Badge>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-start justify-between gap-2">
                      <h3 class="text-slate-200 font-medium text-sm">{dec.decision}</h3>
                      <span class="text-slate-600 text-xs font-mono shrink-0">{dec.date}</span>
                    </div>
                    <p class="text-slate-500 text-sm mt-1">{dec.context}</p>
                    
                    <details class="mt-3 group">
                      <summary class="cursor-pointer text-sm text-slate-500 hover:text-slate-400 flex items-center gap-2">
                        <span class="transform transition-transform group-open:rotate-90 text-xs">▸</span>
                        Details
                      </summary>
                      <div class="mt-3 pl-4 border-l border-slate-700/50 space-y-3">
                        <div>
                          <span class="text-slate-600 text-xs uppercase tracking-wide">Alternatives:</span>
                          <div class="flex flex-wrap gap-1.5 mt-1">
                            {dec.alternatives.map((alt) => (
                              <span class="px-2 py-0.5 bg-slate-800 rounded text-slate-400 text-xs">{alt}</span>
                            ))}
                          </div>
                        </div>
                        <div>
                          <span class="text-slate-600 text-xs uppercase tracking-wide">Rationale:</span>
                          <p class="text-slate-400 text-sm mt-1">{dec.rationale}</p>
                        </div>
                      </div>
                    </details>
                  </div>
                  <Badge variant={dec.status === 'final' ? 'success' : 'warning'} size="sm">{dec.status}</Badge>
                </div>
              </div>
            ))}
          </div>
        </section>

        <!-- Tasks Tab (Kanban) -->
        <section id="tab-tasks" class="tab-panel hidden">
          <p class="text-slate-500 text-xs uppercase tracking-wide mb-4">All tasks across projects</p>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- To Do Column -->
            <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg">
              <div class="p-3 border-b border-slate-700/50 flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <StatusDot status="error" />
                  <h3 class="font-medium text-sm text-slate-200">To Do</h3>
                </div>
                <span class="bg-red-500/10 text-red-400 text-xs font-mono px-2 py-0.5 rounded">
                  {allTodo.length}
                </span>
              </div>
              <div class="p-3 space-y-2 max-h-[60vh] overflow-y-auto">
                {allTodo.map((task) => (
                  <div class:list={[
                    'bg-slate-800/50 border rounded-lg p-3',
                    task.priority === 'critical' ? 'border-red-500/30' : 
                    task.priority === 'high' ? 'border-amber-500/20' : 'border-slate-700/50'
                  ]}>
                    <p class="text-slate-300 text-sm">{task.title}</p>
                    <p class="text-slate-600 text-xs mt-1">{task.project}</p>
                  </div>
                ))}
                {allTodo.length === 0 && (
                  <p class="text-slate-600 text-sm text-center py-4">No tasks</p>
                )}
              </div>
            </div>

            <!-- In Progress Column -->
            <div class="bg-[#1a2028] border border-amber-500/20 rounded-lg">
              <div class="p-3 border-b border-slate-700/50 flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <StatusDot status="warning" pulse />
                  <h3 class="font-medium text-sm text-slate-200">In Progress</h3>
                </div>
                <span class="bg-amber-500/10 text-amber-400 text-xs font-mono px-2 py-0.5 rounded">
                  {allInProgress.length}
                </span>
              </div>
              <div class="p-3 space-y-2 max-h-[60vh] overflow-y-auto">
                {allInProgress.map((task) => (
                  <div class="bg-amber-500/5 border border-amber-500/20 rounded-lg p-3">
                    <p class="text-slate-300 text-sm">{task.title}</p>
                    <p class="text-slate-600 text-xs mt-1">{task.project}</p>
                  </div>
                ))}
                {allInProgress.length === 0 && (
                  <p class="text-slate-600 text-sm text-center py-4">No tasks</p>
                )}
              </div>
            </div>

            <!-- Done Column -->
            <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg">
              <div class="p-3 border-b border-slate-700/50 flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <StatusDot status="success" />
                  <h3 class="font-medium text-sm text-slate-200">Done</h3>
                </div>
                <span class="bg-green-500/10 text-green-400 text-xs font-mono px-2 py-0.5 rounded">
                  {allDone.length}
                </span>
              </div>
              <div class="p-3">
                <details class="group">
                  <summary class="cursor-pointer text-sm text-slate-500 hover:text-slate-400 flex items-center gap-2 mb-2">
                    <span class="transform transition-transform group-open:rotate-90 text-xs">▸</span>
                    Show completed ({allDone.length})
                  </summary>
                  <div class="space-y-2 max-h-[50vh] overflow-y-auto">
                    {allDone.slice(0, 30).map((task) => (
                      <div class="bg-green-500/5 border border-green-500/10 rounded-lg p-3">
                        <p class="text-slate-500 text-sm">{task.title}</p>
                        <p class="text-slate-700 text-xs">{task.project}</p>
                      </div>
                    ))}
                    {allDone.length > 30 && (
                      <p class="text-slate-700 text-xs text-center py-2">+{allDone.length - 30} more</p>
                    )}
                  </div>
                </details>
              </div>
            </div>
          </div>
        </section>

        <!-- Schedule Tab -->
        <section id="tab-schedule" class="tab-panel hidden">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- Flying Schedule -->
            <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg">
              <div class="p-4 border-b border-slate-700/50 flex items-center justify-between">
                <h3 class="font-medium text-slate-200">Flight Schedule</h3>
                <span class="text-slate-500 text-xs font-mono">{schedule.pilot.projectedHours}</span>
              </div>
              <div class="p-4 space-y-3">
                {tripsWithStatus.map((trip) => (
                  <details class:list={[
                    'group rounded-lg border overflow-hidden',
                    trip.isCurrent ? 'bg-blue-500/5 border-blue-500/20' :
                    trip.isUpcoming ? 'bg-slate-800/50 border-slate-700/50' :
                    'bg-slate-800/30 border-slate-700/30 opacity-60'
                  ]}>
                    <summary class="cursor-pointer p-3 hover:bg-slate-700/20 transition-colors">
                      <div class="flex items-center justify-between">
                        <div>
                          <div class="flex items-center gap-2 mb-0.5">
                            <span class="text-xs font-mono text-slate-500">SEQ {trip.sequence}</span>
                            {trip.isCurrent && <Badge variant="info" size="sm">NOW</Badge>}
                          </div>
                          <p class="text-slate-200 font-medium text-sm">{trip.route}</p>
                          <p class="text-slate-500 text-xs">{trip.dates}</p>
                        </div>
                        <span class="text-blue-400 text-sm font-mono">{trip.credit}</span>
                      </div>
                    </summary>
                    <div class="px-3 pb-3 pt-2 border-t border-slate-700/30">
                      <div class="space-y-1">
                        {trip.details.map((leg) => (
                          <div class="flex items-center justify-between text-sm">
                            <span class="text-slate-600 font-mono text-xs">{leg.date}</span>
                            <span class="text-slate-400">{leg.dep} → {leg.arr}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  </details>
                ))}
              </div>
            </div>

            <!-- Work Windows -->
            <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg">
              <div class="p-4 border-b border-slate-700/50">
                <h3 class="font-medium text-slate-200">Loop Work Windows</h3>
              </div>
              <div class="p-4 space-y-2">
                {workWindowsWithStatus.map((window) => (
                  <div class:list={[
                    'rounded-lg p-3 border transition-all',
                    window.status === 'past' ? 'bg-slate-800/30 border-slate-700/30 opacity-50' :
                    window.status === 'current' ? 'bg-emerald-500/5 border-emerald-500/20' :
                    window.highlight === 'big' ? 'bg-amber-500/5 border-amber-500/20' :
                    'bg-slate-800/50 border-slate-700/50'
                  ]}>
                    <div class="flex items-center justify-between mb-1">
                      <span class:list={[
                        'font-medium text-sm',
                        window.status === 'past' ? 'text-slate-600' :
                        window.status === 'current' ? 'text-emerald-400' :
                        window.highlight === 'big' ? 'text-amber-400' : 'text-slate-300'
                      ]}>{window.dateRange}</span>
                      <div class="flex items-center gap-2">
                        {window.highlight === 'big' && window.status !== 'past' && (
                          <Badge variant="warning" size="sm">BIG</Badge>
                        )}
                        {window.status === 'current' && (
                          <span class="text-emerald-400 text-xs font-mono">{window.daysRemaining}d left</span>
                        )}
                        {window.status === 'past' && (
                          <span class="text-slate-600 text-xs">PAST</span>
                        )}
                        {window.status === 'upcoming' && (
                          <span class="text-slate-500 text-xs font-mono">in {getDaysUntil(window.start)}d</span>
                        )}
                      </div>
                    </div>
                    <p class:list={[
                      'text-sm',
                      window.status === 'past' ? 'text-slate-600' :
                      window.status === 'current' ? 'text-emerald-300/60' : 'text-slate-500'
                    ]}>
                      {window.label} · {window.totalDays}d
                    </p>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </section>

        <!-- AA Insights Tab -->
        <section id="tab-aa-insights" class="tab-panel hidden">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- Bid Cycle -->
            <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg">
              <div class="p-4 border-b border-slate-700/50">
                <h3 class="font-medium text-slate-200">Bid Cycle</h3>
              </div>
              <div class="p-4 space-y-3">
                <div class:list={[
                  'rounded-lg p-4 border',
                  isUrgent(daysUntilBidOpens) ? 'bg-amber-500/5 border-amber-500/20' : 'bg-slate-800/50 border-slate-700/50'
                ]}>
                  <div class="flex items-center justify-between mb-1">
                    <span class="text-slate-400 text-sm">Bid Opens</span>
                    <span class:list={['text-xl font-mono font-semibold', isUrgent(daysUntilBidOpens) ? 'text-amber-400' : 'text-slate-200']}>
                      {isExpired(daysUntilBidOpens) ? 'NOW' : `${daysUntilBidOpens}d`}
                    </span>
                  </div>
                  <p class="text-slate-300 text-sm">{aaInsights.bidCycle.nextBidOpens}</p>
                  <p class="text-slate-600 text-xs mt-1">Usually {aaInsights.bidCycle.opens}</p>
                </div>

                <div class:list={[
                  'rounded-lg p-4 border',
                  isUrgent(daysUntilBidCloses) ? 'bg-red-500/5 border-red-500/20' : 'bg-slate-800/50 border-slate-700/50'
                ]}>
                  <div class="flex items-center justify-between mb-1">
                    <span class="text-slate-400 text-sm">Bid Closes</span>
                    <span class:list={['text-xl font-mono font-semibold', isUrgent(daysUntilBidCloses) ? 'text-red-400' : 'text-slate-200']}>
                      {isExpired(daysUntilBidCloses) ? 'CLOSED' : `${daysUntilBidCloses}d`}
                    </span>
                  </div>
                  <p class="text-slate-300 text-sm">{aaInsights.bidCycle.nextBidCloses}</p>
                  <p class="text-slate-600 text-xs mt-1">Usually {aaInsights.bidCycle.closes}</p>
                </div>

                <div class="rounded-lg p-4 bg-slate-800/50 border border-slate-700/50">
                  <span class="text-slate-400 text-sm">Award Published</span>
                  <p class="text-slate-300 text-sm mt-1">{aaInsights.bidCycle.awardPublished}</p>
                </div>
              </div>
            </div>

            <!-- Bidding Tips -->
            <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg">
              <div class="p-4 border-b border-slate-700/50">
                <h3 class="font-medium text-slate-200">Bidding Strategy</h3>
              </div>
              <div class="p-4">
                <ul class="space-y-2">
                  {aaInsights.tips?.map((tip) => (
                    <li class="flex items-start gap-2 text-sm">
                      <StatusDot status="info" size="sm" />
                      <span class="text-slate-400">{tip}</span>
                    </li>
                  )) || (
                    <li class="text-slate-500 text-sm">No tips available</li>
                  )}
                </ul>
              </div>
            </div>
          </div>
        </section>

        <!-- Activity Tab -->
        <section id="tab-activity" class="tab-panel hidden">
          <div class="bg-[#1a2028] border border-slate-700/50 rounded-lg">
            <div class="p-4 border-b border-slate-700/50">
              <h3 class="font-medium text-slate-200">Activity Log</h3>
            </div>
            <div class="divide-y divide-slate-700/30">
              {activity.map((item) => (
                <div class="flex items-center gap-4 px-4 py-3">
                  <span class="text-slate-600 text-xs font-mono w-24 shrink-0">{item.date}</span>
                  <span class="text-slate-400 text-sm">{item.action}</span>
                </div>
              ))}
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <style>
    .tab-btn {
      color: #64748b;
      background: transparent;
    }
    .tab-btn:hover {
      color: #94a3b8;
      background: rgba(51, 65, 85, 0.3);
    }
    .tab-btn.active {
      color: #10b981;
      background: rgba(16, 185, 129, 0.1);
    }
  </style>

  <script>
    // Tab switching logic
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabPanels = document.querySelectorAll('.tab-panel');
    const mobileSelect = document.getElementById('mobile-tab-select') as HTMLSelectElement;

    function switchTab(tabId: string) {
      tabBtns.forEach(btn => btn.classList.remove('active'));
      tabPanels.forEach(panel => panel.classList.add('hidden'));
      
      document.querySelector(`[data-tab="${tabId}"]`)?.classList.add('active');
      document.getElementById(`tab-${tabId}`)?.classList.remove('hidden');
      
      if (mobileSelect) mobileSelect.value = tabId;
    }

    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const tabId = btn.getAttribute('data-tab');
        if (tabId) switchTab(tabId);
      });
    });

    mobileSelect?.addEventListener('change', (e) => {
      switchTab((e.target as HTMLSelectElement).value);
    });
  </script>
</DashboardLayout>
