---
import Layout from '../layouts/Layout.astro';

// Support stats - would be fetched from Supabase in production
const stats = {
  open: 12,
  pending: 5,
  resolved: 43,
  avgResponseTime: '2.4h',
  aiHandled: 68,
  satisfaction: 94
};

// Mock tickets for UI - real data comes from Supabase
const tickets = [
  {
    id: '1',
    ticket_number: 'LOOP-2601-0001',
    subject: 'Unable to link my credit card',
    email: 'user@example.com',
    category: 'bug',
    priority: 'high',
    status: 'open',
    created_at: '2026-01-30T14:30:00Z',
    ai_confidence: 0.85,
    sentiment: 'frustrated'
  },
  {
    id: '2', 
    ticket_number: 'LOOP-2601-0002',
    subject: 'How do I earn Cred at local stores?',
    email: 'newuser@gmail.com',
    category: 'general',
    priority: 'low',
    status: 'waiting_customer',
    created_at: '2026-01-30T13:15:00Z',
    ai_confidence: 0.92,
    ai_handled: true,
    sentiment: 'neutral'
  },
  {
    id: '3',
    ticket_number: 'LOOP-2601-0003',
    subject: 'Partnership opportunity - Local Coffee Chain',
    email: 'biz@localcoffee.com',
    category: 'partnership',
    priority: 'normal',
    status: 'open',
    created_at: '2026-01-30T10:00:00Z',
    ai_confidence: 0.78,
    sentiment: 'positive'
  }
];

function getPriorityColor(priority: string): string {
  switch (priority) {
    case 'critical': return 'bg-red-500/20 text-red-400 border-red-500/30';
    case 'high': return 'bg-orange-500/20 text-orange-400 border-orange-500/30';
    case 'normal': return 'bg-blue-500/20 text-blue-400 border-blue-500/30';
    case 'low': return 'bg-slate-500/20 text-slate-400 border-slate-500/30';
    default: return 'bg-slate-500/20 text-slate-400 border-slate-500/30';
  }
}

function getStatusColor(status: string): string {
  switch (status) {
    case 'open': return 'bg-yellow-500/20 text-yellow-400';
    case 'in_progress': return 'bg-blue-500/20 text-blue-400';
    case 'waiting_customer': return 'bg-purple-500/20 text-purple-400';
    case 'resolved': return 'bg-green-500/20 text-green-400';
    case 'closed': return 'bg-slate-500/20 text-slate-400';
    default: return 'bg-slate-500/20 text-slate-400';
  }
}

function getCategoryIcon(category: string): string {
  switch (category) {
    case 'bug': return 'ğŸ›';
    case 'billing': return 'ğŸ’³';
    case 'account': return 'ğŸ‘¤';
    case 'feature': return 'âœ¨';
    case 'merchant': return 'ğŸª';
    case 'partnership': return 'ğŸ¤';
    case 'general': return 'â“';
    case 'feedback': return 'ğŸ’¬';
    default: return 'ğŸ“§';
  }
}

function getSentimentIcon(sentiment: string): string {
  switch (sentiment) {
    case 'positive': return 'ğŸ˜Š';
    case 'neutral': return 'ğŸ˜';
    case 'frustrated': return 'ğŸ˜¤';
    case 'angry': return 'ğŸ˜¡';
    default: return '';
  }
}

function formatDate(dateStr: string): string {
  const date = new Date(dateStr);
  const now = new Date();
  const diff = now.getTime() - date.getTime();
  const hours = Math.floor(diff / (1000 * 60 * 60));
  
  if (hours < 1) return 'Just now';
  if (hours < 24) return `${hours}h ago`;
  const days = Math.floor(hours / 24);
  return `${days}d ago`;
}
---

<Layout title="Support Command Center | Loop">
  <!-- Auth loading overlay -->
  <div id="auth-overlay" class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center">
    <div class="text-center">
      <div class="text-4xl mb-4 animate-pulse">ğŸ”</div>
      <p class="text-slate-400">Checking access...</p>
    </div>
  </div>

  <div class="min-h-screen p-6">
    <!-- Header -->
    <header class="mb-8">
      <div class="flex items-center justify-between">
        <div>
          <a href="/" class="text-slate-400 hover:text-white text-sm mb-2 inline-block">â† Back to Dashboard</a>
          <h1 class="text-3xl font-bold">ğŸ§ Support Command Center</h1>
          <p class="text-slate-400 mt-1">AI-powered customer support for Loop</p>
        </div>
        <div class="flex gap-3">
          <button class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg font-medium transition-colors">
            Run AI Triage
          </button>
          <button class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium transition-colors">
            Settings
          </button>
        </div>
      </div>
    </header>

    <!-- Stats Cards -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
      <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
        <div class="text-2xl font-bold text-yellow-400">{stats.open}</div>
        <div class="text-slate-400 text-sm">Open Tickets</div>
      </div>
      <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
        <div class="text-2xl font-bold text-purple-400">{stats.pending}</div>
        <div class="text-slate-400 text-sm">Awaiting Reply</div>
      </div>
      <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
        <div class="text-2xl font-bold text-green-400">{stats.resolved}</div>
        <div class="text-slate-400 text-sm">Resolved (30d)</div>
      </div>
      <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
        <div class="text-2xl font-bold text-blue-400">{stats.avgResponseTime}</div>
        <div class="text-slate-400 text-sm">Avg Response</div>
      </div>
      <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
        <div class="text-2xl font-bold text-emerald-400">{stats.aiHandled}%</div>
        <div class="text-slate-400 text-sm">AI Handled</div>
      </div>
      <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
        <div class="text-2xl font-bold text-pink-400">{stats.satisfaction}%</div>
        <div class="text-slate-400 text-sm">Satisfaction</div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Ticket List -->
      <div class="lg:col-span-2">
        <div class="bg-slate-800 rounded-xl border border-slate-700">
          <div class="p-4 border-b border-slate-700 flex items-center justify-between">
            <h2 class="text-lg font-semibold">Recent Tickets</h2>
            <div class="flex gap-2">
              <select class="bg-slate-700 text-sm rounded-lg px-3 py-1.5 border border-slate-600">
                <option>All Status</option>
                <option>Open</option>
                <option>Pending</option>
                <option>Resolved</option>
              </select>
              <select class="bg-slate-700 text-sm rounded-lg px-3 py-1.5 border border-slate-600">
                <option>All Categories</option>
                <option>Bug</option>
                <option>Billing</option>
                <option>Account</option>
                <option>Feature</option>
              </select>
            </div>
          </div>
          
          <div class="divide-y divide-slate-700">
            {tickets.map(ticket => (
              <div class="p-4 hover:bg-slate-700/50 transition-colors cursor-pointer">
                <div class="flex items-start gap-4">
                  <div class="text-2xl">{getCategoryIcon(ticket.category)}</div>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                      <span class="text-xs text-slate-500 font-mono">{ticket.ticket_number}</span>
                      <span class={`text-xs px-2 py-0.5 rounded-full ${getStatusColor(ticket.status)}`}>
                        {ticket.status.replace('_', ' ')}
                      </span>
                      <span class={`text-xs px-2 py-0.5 rounded border ${getPriorityColor(ticket.priority)}`}>
                        {ticket.priority}
                      </span>
                      {ticket.ai_handled && (
                        <span class="text-xs px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-400">
                          ğŸ¤– AI handled
                        </span>
                      )}
                    </div>
                    <h3 class="font-medium text-white truncate">{ticket.subject}</h3>
                    <div class="flex items-center gap-3 mt-1 text-sm text-slate-400">
                      <span>{ticket.email}</span>
                      <span>â€¢</span>
                      <span>{formatDate(ticket.created_at)}</span>
                      <span>â€¢</span>
                      <span>{getSentimentIcon(ticket.sentiment)} {ticket.sentiment}</span>
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="text-xs text-slate-500">AI Confidence</div>
                    <div class="text-sm font-medium text-emerald-400">
                      {Math.round(ticket.ai_confidence * 100)}%
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>
          
          <div class="p-4 border-t border-slate-700 text-center">
            <button class="text-blue-400 hover:text-blue-300 text-sm">
              Load more tickets â†’
            </button>
          </div>
        </div>
      </div>

      <!-- Right Sidebar -->
      <div class="space-y-6">
        <!-- Quick Actions -->
        <div class="bg-slate-800 rounded-xl border border-slate-700 p-4">
          <h3 class="font-semibold mb-4">ğŸš€ Quick Actions</h3>
          <div class="space-y-2">
            <button class="w-full text-left px-3 py-2 rounded-lg bg-slate-700/50 hover:bg-slate-700 transition-colors text-sm">
              ğŸ“§ Check support inbox
            </button>
            <button class="w-full text-left px-3 py-2 rounded-lg bg-slate-700/50 hover:bg-slate-700 transition-colors text-sm">
              ğŸ”„ Re-run AI triage
            </button>
            <button class="w-full text-left px-3 py-2 rounded-lg bg-slate-700/50 hover:bg-slate-700 transition-colors text-sm">
              ğŸ“ Update knowledge base
            </button>
            <button class="w-full text-left px-3 py-2 rounded-lg bg-slate-700/50 hover:bg-slate-700 transition-colors text-sm">
              ğŸ“Š Export report
            </button>
          </div>
        </div>

        <!-- Channels -->
        <div class="bg-slate-800 rounded-xl border border-slate-700 p-4">
          <h3 class="font-semibold mb-4">ğŸ“¡ Support Channels</h3>
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-green-500"></span>
                <span class="text-sm">Email</span>
              </div>
              <span class="text-xs text-slate-400">support@looplocal.io</span>
            </div>
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-yellow-500"></span>
                <span class="text-sm">Website Form</span>
              </div>
              <span class="text-xs text-slate-400">Pending setup</span>
            </div>
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-slate-500"></span>
                <span class="text-sm">In-App</span>
              </div>
              <span class="text-xs text-slate-400">Not configured</span>
            </div>
          </div>
        </div>

        <!-- Category Breakdown -->
        <div class="bg-slate-800 rounded-xl border border-slate-700 p-4">
          <h3 class="font-semibold mb-4">ğŸ“Š By Category (30d)</h3>
          <div class="space-y-2">
            {[
              { name: 'General', count: 18, icon: 'â“' },
              { name: 'Bug Reports', count: 12, icon: 'ğŸ›' },
              { name: 'Account', count: 8, icon: 'ğŸ‘¤' },
              { name: 'Feature Requests', count: 5, icon: 'âœ¨' },
            ].map(cat => (
              <div class="flex items-center justify-between">
                <span class="text-sm">{cat.icon} {cat.name}</span>
                <span class="text-sm text-slate-400">{cat.count}</span>
              </div>
            ))}
          </div>
        </div>

        <!-- Burt's Notes -->
        <div class="bg-gradient-to-br from-emerald-900/20 to-slate-800 rounded-xl border border-emerald-500/20 p-4">
          <h3 class="font-semibold mb-3 flex items-center gap-2">
            ğŸ› ï¸ Burt's Notes
          </h3>
          <p class="text-sm text-slate-300">
            "I'm monitoring incoming tickets and will ping you when something needs attention. 
            Most questions about earning Cred are being auto-handled. Partnership inquiries 
            always get escalated to you."
          </p>
          <div class="mt-3 text-xs text-slate-500">
            Last check: 5 minutes ago
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="mt-8 text-center text-slate-500 text-sm">
      <p>Support system powered by AI triage â€¢ Tickets sync in real-time</p>
    </footer>
  </div>

  <script>
    import { supabase, isAllowedEmail } from '../lib/supabase'

    // Auth guard - check if user is logged in
    async function checkAuth() {
      const { data: { session } } = await supabase.auth.getSession()
      
      if (!session?.user?.email || !isAllowedEmail(session.user.email)) {
        // Not logged in or not allowed - redirect to login
        window.location.href = '/login?redirect=/support'
        return false
      }
      
      // Hide the loading overlay
      const overlay = document.getElementById('auth-overlay')
      if (overlay) overlay.style.display = 'none'
      return true
    }
    
    checkAuth()

    // TODO: Connect to Supabase realtime for live ticket updates
  </script>

  <style>
    /* Hide content until auth check completes */
    body.auth-loading > div {
      visibility: hidden;
    }
  </style>
</Layout>
